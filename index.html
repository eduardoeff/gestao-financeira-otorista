<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Financeira - Gordinho do Comfort</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; text-align: center; }
        .stat-value { font-size: 2.5rem; font-weight: bold; margin: 10px 0; }
        .stat-label { font-size: 0.9rem; opacity: 0.9; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .input-field { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; }
        .input-field:focus { outline: none; border-color: #667eea; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 500px; margin: 50px auto; max-height: 90vh; overflow-y: auto; }
        .nav-bar { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 15px; display: flex; justify-content: space-around; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 100; }
        .nav-item { text-align: center; cursor: pointer; padding: 10px; border-radius: 10px; transition: all 0.3s; flex: 1; }
        .nav-item:hover { background: #f7fafc; }
        .nav-item.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 5px; }
        .nav-label { font-size: 0.75rem; font-weight: 600; }
        .header { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { width: 50px; height: 50px; border-radius: 50%; }
        .expense-item { background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { background: #ef4444; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; }
        .delete-btn:hover { background: #dc2626; }
        .chart-container { position: relative; height: 300px; margin-top: 20px; }
        .filter-select { padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0; font-size: 1rem; cursor: pointer; }
        .comparison-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-top: 8px; }
        .comparison-positive { background: #d1fae5; color: #065f46; }
        .comparison-negative { background: #fee2e2; color: #991b1b; }
        .indicator-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .indicator-card { background: #f8fafc; padding: 15px; border-radius: 10px; text-align: center; }
        .indicator-value { font-size: 1.5rem; font-weight: bold; color: #667eea; margin: 8px 0; }
        .indicator-label { font-size: 0.85rem; color: #64748b; }
        .indicator-comparison { font-size: 0.75rem; margin-top: 5px; }
        .section { display: none; }
        .section.active { display: block; }
        .login-container { max-width: 400px; margin: 100px auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .goal-type-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .goal-type-btn { flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s; }
        .goal-type-btn.active { border-color: #667eea; background: #f0f4ff; }
        .week-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .week-btn { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; text-align: center; }
        .week-btn.active { border-color: #667eea; background: #f0f4ff; }
        .goal-display { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px; }
        .goal-value { font-size: 2rem; font-weight: bold; }
        .goal-label { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; }
        .progress-bar { width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981 0%, #059669 100%); transition: width 0.3s; }
    </style>
</head>
<body>
    <!-- Login -->
    <div id="loginSection" class="section active">
        <div class="login-container">
            <div class="card">
                <div style="text-align: center; margin-bottom: 30px;">
                    <img src="https://cdn.abacus.ai/02e9c2c2-e0e0-11ef-8e3e-525400ef5e0e_logo_gordinho_comfort.png" alt="Logo" class="logo" style="width: 100px; height: 100px; margin: 0 auto;">
                    <h1 style="font-size: 1.8rem; font-weight: bold; margin-top: 15px; color: #1e293b;">Gest√£o Financeira</h1>
                    <p style="color: #64748b; margin-top: 5px;">Gordinho do Comfort</p>
                </div>
                <input type="email" id="loginEmail" class="input-field" placeholder="Email">
                <input type="password" id="loginPassword" class="input-field" placeholder="Senha">
                <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">Entrar</button>
                <button onclick="register()" class="btn" style="width: 100%; background: #f1f5f9;">Criar Conta</button>
            </div>
        </div>
    </div>

    <!-- App -->
    <div id="appSection" class="section">
        <div class="container" style="padding-bottom: 100px;">
            <!-- Header -->
            <div class="header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="https://cdn.abacus.ai/02e9c2c2-e0e0-11ef-8e3e-525400ef5e0e_logo_gordinho_comfort.png" alt="Logo" class="logo">
                    <div>
                        <h2 style="font-size: 1.3rem; font-weight: bold; color: #1e293b;">Gest√£o Financeira</h2>
                        <p style="font-size: 0.85rem; color: #64748b;" id="userEmail"></p>
                    </div>
                </div>
                <button onclick="logout()" class="btn" style="background: #f1f5f9;">Sair</button>
            </div>

            <!-- Dashboard -->
            <div id="dashboardSection" class="section active">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="font-size: 1.5rem; font-weight: bold;">üìä Dashboard</h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="periodFilter" class="filter-select" onchange="updateDashboard()">
                                <option value="week">√öltima Semana</option>
                                <option value="month" selected>M√™s Atual</option>
                                <option value="year">Ano Atual</option>
                                <option value="lastMonth">M√™s Anterior</option>
                            </select>
                            <button onclick="exportPDF()" class="btn btn-primary">üìÑ Exportar PDF</button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <div class="stat-label">Ganhos</div>
                            <div class="stat-value" id="totalEarnings">R$ 0,00</div>
                            <div class="comparison-badge" id="earningsComparison"></div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <div class="stat-label">Despesas</div>
                            <div class="stat-value" id="totalExpenses">R$ 0,00</div>
                            <div class="comparison-badge" id="expensesComparison"></div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                            <div class="stat-label">Lucro</div>
                            <div class="stat-value" id="profit">R$ 0,00</div>
                            <div class="comparison-badge" id="profitComparison"></div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                            <div class="stat-label">Casa</div>
                            <div class="stat-value" id="totalHouse">R$ 0,00</div>
                            <div class="comparison-badge" id="houseComparison"></div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);">
                            <div class="stat-label">Saldo Final</div>
                            <div class="stat-value" id="finalBalance">R$ 0,00</div>
                            <div class="comparison-badge" id="balanceComparison"></div>
                        </div>
                    </div>
                </div>

                <!-- Indicadores de Efici√™ncia -->
                <div class="card">
                    <h3 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 15px;">üìà Indicadores de Efici√™ncia</h3>
                    <div class="indicator-grid">
                        <div class="indicator-card">
                            <div class="indicator-label">Ticket M√©dio</div>
                            <div class="indicator-value" id="avgTicket">R$ 0,00</div>
                            <div class="indicator-comparison" id="avgTicketComparison"></div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-label">Custo/Dia</div>
                            <div class="indicator-value" id="costPerDay">R$ 0,00</div>
                            <div class="indicator-comparison" id="costPerDayComparison"></div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-label">Margem</div>
                            <div class="indicator-value" id="margin">0%</div>
                            <div class="indicator-comparison" id="marginComparison"></div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-label">Meta Di√°ria</div>
                            <div class="indicator-value" id="dailyGoalIndicator">R$ 0,00</div>
                            <div class="indicator-comparison" id="goalProgress"></div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Evolu√ß√£o -->
                <div class="card">
                    <h3 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 15px;">üìä Evolu√ß√£o (M√™s Completo)</h3>
                    <div class="chart-container">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Ganhos -->
            <div id="earningsSection" class="section">
                <div class="card">
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;">üí∞ Ganhos Di√°rios</h2>
                    <button onclick="openEarningsModal()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px;">+ Adicionar Ganho do Dia</button>
                    <div id="earningsList"></div>
                </div>
            </div>

            <!-- Metas -->
            <div id="goalsSection" class="section">
                <div class="card">
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;">üéØ Metas</h2>

                    <div class="goal-type-selector">
                        <button class="goal-type-btn active" onclick="selectGoalType('monthly')">
                            <div style="font-size: 1.5rem; margin-bottom: 5px;">üìÖ</div>
                            <div style="font-weight: 600;">Meta Mensal</div>
                        </button>
                        <button class="goal-type-btn" onclick="selectGoalType('weekly')">
                            <div style="font-size: 1.5rem; margin-bottom: 5px;">üìÜ</div>
                            <div style="font-weight: 600;">Meta Semanal</div>
                        </button>
                    </div>

                    <!-- Meta Mensal -->
                    <div id="monthlyGoalForm">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Selecione o M√™s:</label>
                        <input type="month" id="monthlyGoalMonth" class="input-field" value="">

                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Valor da Meta Mensal:</label>
                        <input type="number" id="monthlyGoalValue" class="input-field" placeholder="Ex: 5000" step="0.01">

                        <button onclick="saveMonthlyGoal()" class="btn btn-primary" style="width: 100%;">Salvar Meta Mensal</button>
                    </div>

                    <!-- Meta Semanal -->
                    <div id="weeklyGoalForm" style="display: none;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Selecione o M√™s:</label>
                        <input type="month" id="weeklyGoalMonth" class="input-field" value="">

                        <label style="display: block; margin-bottom: 12px; font-weight: 600;">Selecione as Semanas:</label>
                        <div class="week-selector" id="weekSelector"></div>

                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Valor da Meta Semanal:</label>
                        <input type="number" id="weeklyGoalValue" class="input-field" placeholder="Ex: 1250" step="0.01">

                        <button onclick="saveWeeklyGoal()" class="btn btn-primary" style="width: 100%;">Salvar Meta Semanal</button>
                    </div>

                    <!-- Exibi√ß√£o da Meta Atual -->
                    <div id="currentGoalDisplay" style="display: none;">
                        <div class="goal-display">
                            <div class="goal-label">Meta Di√°ria Atual</div>
                            <div class="goal-value" id="currentDailyGoal">R$ 0,00</div>
                            <div class="goal-label" id="goalPeriodInfo"></div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="goalProgressBar" style="width: 0%;"></div>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9rem;" id="goalProgressText"></div>
                        </div>
                        <button onclick="clearGoal()" class="btn delete-btn" style="width: 100%; margin-top: 15px;">Limpar Meta</button>
                    </div>
                </div>
            </div>

            <!-- Trabalho -->
            <div id="workSection" class="section">
                <div class="card">
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;">üöó Despesas de Trabalho</h2>
                    <button onclick="openExpenseModal()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px;">+ Adicionar Despesa</button>
                    <div id="expensesList"></div>
                </div>
            </div>

            <!-- Casa -->
            <div id="houseSection" class="section">
                <div class="card">
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;">üè† Despesas de Casa</h2>
                    <button onclick="openHouseModal()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px;">+ Adicionar Despesa</button>
                    <div id="houseList"></div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-bar">
            <div class="nav-item active" onclick="showSection('dashboard')">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">Dashboard</div>
            </div>
            <div class="nav-item" onclick="showSection('earnings')">
                <div class="nav-icon">üí∞</div>
                <div class="nav-label">Ganhos</div>
            </div>
            <div class="nav-item" onclick="showSection('goals')">
                <div class="nav-icon">üéØ</div>
                <div class="nav-label">Metas</div>
            </div>
            <div class="nav-item" onclick="showSection('work')">
                <div class="nav-icon">üöó</div>
                <div class="nav-label">Trabalho</div>
            </div>
            <div class="nav-item" onclick="showSection('house')">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Casa</div>
            </div>
        </div>
    </div>

    <!-- Modal Ganhos -->
    <div id="earningsModal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 20px;">üí∞ Adicionar Ganho do Dia</h3>
            <input type="date" id="earningDate" class="input-field">
            <input type="number" id="earningAmount" class="input-field" placeholder="Valor Total do Dia" step="0.01">
            <select id="earningPlatform" class="input-field">
                <option value="Uber">Uber</option>
                <option value="99">99</option>
                <option value="InDriver">InDriver</option>
                <option value="Outros">Outros</option>
            </select>
            <textarea id="earningNotes" class="input-field" placeholder="Observa√ß√µes (opcional)" rows="3"></textarea>
            <div style="display: flex; gap: 10px;">
                <button onclick="saveEarning()" class="btn btn-primary" style="flex: 1;">Salvar</button>
                <button onclick="closeModal('earningsModal')" class="btn" style="flex: 1; background: #f1f5f9;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Despesas Trabalho -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 20px;">üöó Adicionar Despesa de Trabalho</h3>
            <input type="date" id="expenseDate" class="input-field">
            <select id="expenseCategory" class="input-field">
                <option value="Combust√≠vel">Combust√≠vel</option>
                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                <option value="Lavagem">Lavagem</option>
                <option value="Ped√°gio">Ped√°gio</option>
                <option value="Estacionamento">Estacionamento</option>
                <option value="Outros">Outros</option>
            </select>
            <input type="number" id="expenseAmount" class="input-field" placeholder="Valor" step="0.01">
            <textarea id="expenseNotes" class="input-field" placeholder="Observa√ß√µes (opcional)" rows="3"></textarea>
            <div style="display: flex; gap: 10px;">
                <button onclick="saveExpense()" class="btn btn-primary" style="flex: 1;">Salvar</button>
                <button onclick="closeModal('expenseModal')" class="btn" style="flex: 1; background: #f1f5f9;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Despesas Casa -->
    <div id="houseModal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 20px;">üè† Adicionar Despesa de Casa</h3>
            <input type="date" id="houseDate" class="input-field">
            <select id="houseCategory" class="input-field">
                <option value="Aluguel">Aluguel</option>
                <option value="√Ågua">√Ågua</option>
                <option value="Luz">Luz</option>
                <option value="Internet">Internet</option>
                <option value="Mercado">Mercado</option>
                <option value="Outros">Outros</option>
            </select>
            <input type="number" id="houseAmount" class="input-field" placeholder="Valor" step="0.01">
            <textarea id="houseNotes" class="input-field" placeholder="Observa√ß√µes (opcional)" rows="3"></textarea>
            <div style="display: flex; gap: 10px;">
                <button onclick="saveHouse()" class="btn btn-primary" style="flex: 1;">Salvar</button>
                <button onclick="closeModal('houseModal')" class="btn" style="flex: 1; background: #f1f5f9;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDWMlDtQ1dhvE3mLYhRakJ1oM8TJyJd6s8",
            authDomain: "gestao-motorista-4155f.firebaseapp.com",
            projectId: "gestao-motorista-4155f",
            storageBucket: "gestao-motorista-4155f.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let evolutionChart = null;
        let currentGoalType = 'monthly';

        // Auth
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginSection').classList.remove('active');
                document.getElementById('appSection').classList.add('active');
                document.getElementById('userEmail').textContent = user.email;
                loadData();
                setDefaultDates();
            } else {
                document.getElementById('loginSection').classList.add('active');
                document.getElementById('appSection').classList.remove('active');
            }
        });

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, password).catch(e => alert('Erro: ' + e.message));
        }

        function register() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            auth.createUserWithEmailAndPassword(email, password).catch(e => alert('Erro: ' + e.message));
        }

        function logout() {
            auth.signOut();
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('#appSection > .container > .section').forEach(s => s.classList.remove('active'));
            document.getElementById(section + 'Section').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (section === 'dashboard') updateDashboard();
            if (section === 'goals') loadCurrentGoal();
        }

        // Modals
        function openEarningsModal() {
            document.getElementById('earningsModal').style.display = 'block';
            document.getElementById('earningDate').valueAsDate = new Date();
        }

        function openExpenseModal() {
            document.getElementById('expenseModal').style.display = 'block';
            document.getElementById('expenseDate').valueAsDate = new Date();
        }

        function openHouseModal() {
            document.getElementById('houseModal').style.display = 'block';
            document.getElementById('houseDate').valueAsDate = new Date();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Set Default Dates
        function setDefaultDates() {
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            document.getElementById('monthlyGoalMonth').value = currentMonth;
            document.getElementById('weeklyGoalMonth').value = currentMonth;
            generateWeekSelector(currentMonth);
        }

        // Goals
        function selectGoalType(type) {
            currentGoalType = type;
            document.querySelectorAll('.goal-type-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (type === 'monthly') {
                document.getElementById('monthlyGoalForm').style.display = 'block';
                document.getElementById('weeklyGoalForm').style.display = 'none';
            } else {
                document.getElementById('monthlyGoalForm').style.display = 'none';
                document.getElementById('weeklyGoalForm').style.display = 'block';
                const month = document.getElementById('weeklyGoalMonth').value;
                if (month) generateWeekSelector(month);
            }
        }

        function generateWeekSelector(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);

            const weeks = [];
            let currentWeekStart = new Date(firstDay);

            while (currentWeekStart <= lastDay) {
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                if (weekEnd > lastDay) {
                    weekEnd.setTime(lastDay.getTime());
                }

                weeks.push({
                    start: new Date(currentWeekStart),
                    end: new Date(weekEnd)
                });

                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            }

            const selector = document.getElementById('weekSelector');
            selector.innerHTML = weeks.map((week, idx) => `
                <button class="week-btn" onclick="toggleWeek(${idx})" data-week="${idx}">
                    <div style="font-weight: 600;">Semana ${idx + 1}</div>
                    <div style="font-size: 0.75rem; color: #64748b; margin-top: 4px;">
                        ${week.start.getDate()}/${week.start.getMonth() + 1} - ${week.end.getDate()}/${week.end.getMonth() + 1}
                    </div>
                </button>
            `).join('');
        }

        function toggleWeek(weekIdx) {
            const btn = document.querySelector(`[data-week="${weekIdx}"]`);
            btn.classList.toggle('active');
        }

        async function saveMonthlyGoal() {
            const month = document.getElementById('monthlyGoalMonth').value;
            const value = parseFloat(document.getElementById('monthlyGoalValue').value);

            if (!month || !value || value <= 0) {
                alert('Preencha todos os campos corretamente!');
                return;
            }

            const [year, monthNum] = month.split('-').map(Number);
            const daysInMonth = new Date(year, monthNum, 0).getDate();
            const dailyGoal = value / daysInMonth;

            try {
                await db.collection('userGoals').doc(currentUser.uid).set({
                    type: 'monthly',
                    month: month,
                    totalValue: value,
                    dailyGoal: dailyGoal,
                    daysInPeriod: daysInMonth,
                    userId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert(`Meta mensal salva! Meta di√°ria: R$ ${dailyGoal.toFixed(2)}`);
                loadCurrentGoal();
            } catch (error) {
                alert('Erro ao salvar meta: ' + error.message);
            }
        }

        async function saveWeeklyGoal() {
            const month = document.getElementById('weeklyGoalMonth').value;
            const value = parseFloat(document.getElementById('weeklyGoalValue').value);
            const selectedWeeks = Array.from(document.querySelectorAll('.week-btn.active')).map(btn => parseInt(btn.dataset.week));

            if (!month || !value || value <= 0 || selectedWeeks.length === 0) {
                alert('Preencha todos os campos e selecione pelo menos uma semana!');
                return;
            }

            const [year, monthNum] = month.split('-').map(Number);
            const firstDay = new Date(year, monthNum - 1, 1);
            const lastDay = new Date(year, monthNum, 0);

            let totalDays = 0;
            selectedWeeks.forEach(weekIdx => {
                const weekStart = new Date(firstDay);
                weekStart.setDate(weekStart.getDate() + (weekIdx * 7));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                if (weekEnd > lastDay) weekEnd.setTime(lastDay.getTime());

                const days = Math.ceil((weekEnd - weekStart) / (1000 * 60 * 60 * 24)) + 1;
                totalDays += days;
            });

            const dailyGoal = value / 7; // Meta semanal dividida por 7 dias

            try {
                await db.collection('userGoals').doc(currentUser.uid).set({
                    type: 'weekly',
                    month: month,
                    selectedWeeks: selectedWeeks,
                    weeklyValue: value,
                    dailyGoal: dailyGoal,
                    daysInPeriod: totalDays,
                    userId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert(`Meta semanal salva! Meta di√°ria: R$ ${dailyGoal.toFixed(2)}`);
                loadCurrentGoal();
            } catch (error) {
                alert('Erro ao salvar meta: ' + error.message);
            }
        }

        async function loadCurrentGoal() {
            try {
                const doc = await db.collection('userGoals').doc(currentUser.uid).get();

                if (doc.exists) {
                    const goal = doc.data();
                    document.getElementById('currentGoalDisplay').style.display = 'block';
                    document.getElementById('currentDailyGoal').textContent = `R$ ${goal.dailyGoal.toFixed(2)}`;

                    let periodInfo = '';
                    if (goal.type === 'monthly') {
                        const [year, month] = goal.month.split('-');
                        periodInfo = `Meta Mensal - ${month}/${year} (${goal.daysInPeriod} dias)`;
                    } else {
                        periodInfo = `Meta Semanal - ${goal.selectedWeeks.length} semana(s) selecionada(s)`;
                    }
                    document.getElementById('goalPeriodInfo').textContent = periodInfo;

                    // Calcular progresso
                    await updateGoalProgress(goal);
                } else {
                    document.getElementById('currentGoalDisplay').style.display = 'none';
                }
            } catch (error) {
                console.error('Erro ao carregar meta:', error);
            }
        }

        async function updateGoalProgress(goal) {
            const today = new Date();
            const [year, month] = goal.month.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);

            const earnings = await db.collection('dailyEarnings')
                .where('userId', '==', currentUser.uid)
                .where('date', '>=', startDate.toISOString().split('T')[0])
                .where('date', '<=', endDate.toISOString().split('T')[0])
                .get();

            let totalEarned = 0;
            earnings.forEach(doc => totalEarned += doc.data().amount);

            const totalGoal = goal.dailyGoal * goal.daysInPeriod;
            const progress = (totalEarned / totalGoal) * 100;

            document.getElementById('goalProgressBar').style.width = Math.min(progress, 100) + '%';
            document.getElementById('goalProgressText').textContent = 
                `R$ ${totalEarned.toFixed(2)} de R$ ${totalGoal.toFixed(2)} (${progress.toFixed(1)}%)`;
        }

        async function clearGoal() {
            if (confirm('Tem certeza que deseja limpar a meta atual?')) {
                try {
                    await db.collection('userGoals').doc(currentUser.uid).delete();
                    document.getElementById('currentGoalDisplay').style.display = 'none';
                    alert('Meta removida com sucesso!');
                } catch (error) {
                    alert('Erro ao remover meta: ' + error.message);
                }
            }
        }

        // Earnings
        async function saveEarning() {
            const date = document.getElementById('earningDate').value;
            const amount = parseFloat(document.getElementById('earningAmount').value);
            const platform = document.getElementById('earningPlatform').value;
            const notes = document.getElementById('earningNotes').value;

            if (!date || !amount) {
                alert('Preencha todos os campos obrigat√≥rios!');
                return;
            }

            try {
                await db.collection('dailyEarnings').add({
                    userId: currentUser.uid,
                    date: date,
                    amount: amount,
                    platform: platform,
                    notes: notes,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal('earningsModal');
                loadEarnings();
                updateDashboard();
            } catch (error) {
                alert('Erro ao salvar: ' + error.message);
            }
        }

        async function loadEarnings() {
            const snapshot = await db.collection('dailyEarnings')
                .where('userId', '==', currentUser.uid)
                .orderBy('date', 'desc')
                .get();

            const list = document.getElementById('earningsList');
            list.innerHTML = snapshot.empty ? '<p style="text-align: center; color: #64748b;">Nenhum ganho registrado</p>' : '';

            snapshot.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="expense-item">
                        <div>
                            <div style="font-weight: 600;">${new Date(data.date).toLocaleDateString('pt-BR')}</div>
                            <div style="font-size: 0.85rem; color: #64748b;">${data.platform}</div>
                            ${data.notes ? `<div style="font-size: 0.8rem; color: #94a3b8; margin-top: 4px;">${data.notes}</div>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #10b981;">R$ ${data.amount.toFixed(2)}</div>
                            <button onclick="deleteItem('dailyEarnings', '${doc.id}')" class="delete-btn" style="margin-top: 8px;">Excluir</button>
                        </div>
                    </div>
                `;
            });
        }

        // Expenses
        async function saveExpense() {
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const notes = document.getElementById('expenseNotes').value;

            if (!date || !amount) {
                alert('Preencha todos os campos obrigat√≥rios!');
                return;
            }

            try {
                await db.collection('expenses').add({
                    userId: currentUser.uid,
                    date: date,
                    category: category,
                    amount: amount,
                    notes: notes,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal('expenseModal');
                loadExpenses();
                updateDashboard();
            } catch (error) {
                alert('Erro ao salvar: ' + error.message);
            }
        }

        async function loadExpenses() {
            const snapshot = await db.collection('expenses')
                .where('userId', '==', currentUser.uid)
                .orderBy('date', 'desc')
                .get();

            const list = document.getElementById('expensesList');
            list.innerHTML = snapshot.empty ? '<p style="text-align: center; color: #64748b;">Nenhuma despesa registrada</p>' : '';

            snapshot.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="expense-item">
                        <div>
                            <div style="font-weight: 600;">${data.category}</div>
                            <div style="font-size: 0.85rem; color: #64748b;">${new Date(data.date).toLocaleDateString('pt-BR')}</div>
                            ${data.notes ? `<div style="font-size: 0.8rem; color: #94a3b8; margin-top: 4px;">${data.notes}</div>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #ef4444;">R$ ${data.amount.toFixed(2)}</div>
                            <button onclick="deleteItem('expenses', '${doc.id}')" class="delete-btn" style="margin-top: 8px;">Excluir</button>
                        </div>
                    </div>
                `;
            });
        }

        // House
        async function saveHouse() {
            const date = document.getElementById('houseDate').value;
            const category = document.getElementById('houseCategory').value;
            const amount = parseFloat(document.getElementById('houseAmount').value);
            const notes = document.getElementById('houseNotes').value;

            if (!date || !amount) {
                alert('Preencha todos os campos obrigat√≥rios!');
                return;
            }

            try {
                await db.collection('houseExpenses').add({
                    userId: currentUser.uid,
                    date: date,
                    category: category,
                    amount: amount,
                    notes: notes,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal('houseModal');
                loadHouse();
                updateDashboard();
            } catch (error) {
                alert('Erro ao salvar: ' + error.message);
            }
        }

        async function loadHouse() {
            const snapshot = await db.collection('houseExpenses')
                .where('userId', '==', currentUser.uid)
                .orderBy('date', 'desc')
                .get();

            const list = document.getElementById('houseList');
            list.innerHTML = snapshot.empty ? '<p style="text-align: center; color: #64748b;">Nenhuma despesa registrada</p>' : '';

            snapshot.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="expense-item">
                        <div>
                            <div style="font-weight: 600;">${data.category}</div>
                            <div style="font-size: 0.85rem; color: #64748b;">${new Date(data.date).toLocaleDateString('pt-BR')}</div>
                            ${data.notes ? `<div style="font-size: 0.8rem; color: #94a3b8; margin-top: 4px;">${data.notes}</div>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #ec4899;">R$ ${data.amount.toFixed(2)}</div>
                            <button onclick="deleteItem('houseExpenses', '${doc.id}')" class="delete-btn" style="margin-top: 8px;">Excluir</button>
                        </div>
                    </div>
                `;
            });
        }

        // Delete
        async function deleteItem(collection, id) {
            if (confirm('Tem certeza que deseja excluir?')) {
                await db.collection(collection).doc(id).delete();
                loadData();
                updateDashboard();
            }
        }

        // Load All Data
        function loadData() {
            loadEarnings();
            loadExpenses();
            loadHouse();
            updateDashboard();
        }

        // Dashboard
        async function updateDashboard() {
            const period = document.getElementById('periodFilter').value;
            const { startDate, endDate } = getDateRange(period);

            // Current Period
            const earnings = await getDataInRange('dailyEarnings', startDate, endDate);
            const expenses = await getDataInRange('expenses', startDate, endDate);
            const house = await getDataInRange('houseExpenses', startDate, endDate);

            const totalEarnings = earnings.reduce((sum, e) => sum + e.amount, 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            const totalHouse = house.reduce((sum, e) => sum + e.amount, 0);
            const profit = totalEarnings - totalExpenses;
            const finalBalance = profit - totalHouse;

            // Previous Period
            const { startDate: prevStart, endDate: prevEnd } = getPreviousDateRange(period);
            const prevEarnings = await getDataInRange('dailyEarnings', prevStart, prevEnd);
            const prevExpenses = await getDataInRange('expenses', prevStart, prevEnd);
            const prevHouse = await getDataInRange('houseExpenses', prevStart, prevEnd);

            const prevTotalEarnings = prevEarnings.reduce((sum, e) => sum + e.amount, 0);
            const prevTotalExpenses = prevExpenses.reduce((sum, e) => sum + e.amount, 0);
            const prevTotalHouse = prevHouse.reduce((sum, e) => sum + e.amount, 0);
            const prevProfit = prevTotalEarnings - prevTotalExpenses;
            const prevFinalBalance = prevProfit - prevTotalHouse;

            // Update UI
            document.getElementById('totalEarnings').textContent = `R$ ${totalEarnings.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `R$ ${totalExpenses.toFixed(2)}`;
            document.getElementById('profit').textContent = `R$ ${profit.toFixed(2)}`;
            document.getElementById('totalHouse').textContent = `R$ ${totalHouse.toFixed(2)}`;
            document.getElementById('finalBalance').textContent = `R$ ${finalBalance.toFixed(2)}`;

            // Comparisons
            updateComparison('earningsComparison', totalEarnings, prevTotalEarnings);
            updateComparison('expensesComparison', totalExpenses, prevTotalExpenses, true);
            updateComparison('profitComparison', profit, prevProfit);
            updateComparison('houseComparison', totalHouse, prevTotalHouse, true);
            updateComparison('balanceComparison', finalBalance, prevFinalBalance);

            // Indicators
            const daysInPeriod = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
            const avgTicket = earnings.length > 0 ? totalEarnings / earnings.length : 0;
            const costPerDay = totalExpenses / daysInPeriod;
            const margin = totalEarnings > 0 ? ((profit / totalEarnings) * 100) : 0;

            const prevDaysInPeriod = Math.ceil((new Date(prevEnd) - new Date(prevStart)) / (1000 * 60 * 60 * 24)) + 1;
            const prevAvgTicket = prevEarnings.length > 0 ? prevTotalEarnings / prevEarnings.length : 0;
            const prevCostPerDay = prevTotalExpenses / prevDaysInPeriod;
            const prevMargin = prevTotalEarnings > 0 ? ((prevProfit / prevTotalEarnings) * 100) : 0;

            document.getElementById('avgTicket').textContent = `R$ ${avgTicket.toFixed(2)}`;
            document.getElementById('costPerDay').textContent = `R$ ${costPerDay.toFixed(2)}`;
            document.getElementById('margin').textContent = `${margin.toFixed(1)}%`;

            updateIndicatorComparison('avgTicketComparison', avgTicket, prevAvgTicket);
            updateIndicatorComparison('costPerDayComparison', costPerDay, prevCostPerDay, true);
            updateIndicatorComparison('marginComparison', margin, prevMargin, false, '%');

            // Goal Indicator
            await updateGoalIndicator(totalEarnings, daysInPeriod);

            // Chart
            updateEvolutionChart(earnings, startDate, endDate);
        }

        async function updateGoalIndicator(totalEarnings, daysInPeriod) {
            try {
                const doc = await db.collection('userGoals').doc(currentUser.uid).get();

                if (doc.exists) {
                    const goal = doc.data();
                    const dailyGoal = goal.dailyGoal;
                    const totalGoal = dailyGoal * daysInPeriod;
                    const progress = (totalEarnings / totalGoal) * 100;

                    document.getElementById('dailyGoalIndicator').textContent = `R$ ${dailyGoal.toFixed(2)}`;

                    const progressText = progress >= 100 
                        ? `‚úÖ Meta atingida! (${progress.toFixed(1)}%)`
                        : `${progress.toFixed(1)}% da meta`;

                    const progressColor = progress >= 100 ? '#10b981' : (progress >= 70 ? '#f59e0b' : '#ef4444');
                    document.getElementById('goalProgress').innerHTML = 
                        `<span style="color: ${progressColor};">${progressText}</span>`;
                } else {
                    document.getElementById('dailyGoalIndicator').textContent = 'R$ 0,00';
                    document.getElementById('goalProgress').textContent = 'Sem meta definida';
                }
            } catch (error) {
                console.error('Erro ao carregar meta:', error);
            }
        }

        function updateComparison(elementId, current, previous, inverse = false) {
            const element = document.getElementById(elementId);
            if (previous === 0) {
                element.textContent = '';
                return;
            }

            const diff = ((current - previous) / previous) * 100;
            const isPositive = inverse ? diff < 0 : diff > 0;
            const arrow = isPositive ? '‚Üë' : '‚Üì';
            const className = isPositive ? 'comparison-positive' : 'comparison-negative';

            element.textContent = `${arrow} ${Math.abs(diff).toFixed(1)}% vs m√™s anterior`;
            element.className = `comparison-badge ${className}`;
        }

        function updateIndicatorComparison(elementId, current, previous, inverse = false, suffix = '') {
            const element = document.getElementById(elementId);
            if (previous === 0) {
                element.textContent = '';
                return;
            }

            const diff = current - previous;
            const isPositive = inverse ? diff < 0 : diff > 0;
            const arrow = isPositive ? '‚Üë' : '‚Üì';
            const color = isPositive ? '#10b981' : '#ef4444';

            element.innerHTML = `<span style="color: ${color};">${arrow} ${Math.abs(diff).toFixed(2)}${suffix} vs anterior</span>`;
        }

        function getDateRange(period) {
            const today = new Date();
            let startDate, endDate;

            if (period === 'week') {
                startDate = new Date(today);
                startDate.setDate(today.getDate() - 7);
                endDate = today;
            } else if (period === 'month') {
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = today;
            } else if (period === 'year') {
                startDate = new Date(today.getFullYear(), 0, 1);
                endDate = today;
            } else if (period === 'lastMonth') {
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            }

            return {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            };
        }

        function getPreviousDateRange(period) {
            const today = new Date();
            let startDate, endDate;

            if (period === 'week') {
                startDate = new Date(today);
                startDate.setDate(today.getDate() - 14);
                endDate = new Date(today);
                endDate.setDate(today.getDate() - 7);
            } else if (period === 'month') {
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            } else if (period === 'year') {
                startDate = new Date(today.getFullYear() - 1, 0, 1);
                endDate = new Date(today.getFullYear() - 1, 11, 31);
            } else if (period === 'lastMonth') {
                startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                endDate = new Date(today.getFullYear(), today.getMonth() - 1, 0);
            }

            return {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            };
        }

        async function getDataInRange(collection, startDate, endDate) {
            const snapshot = await db.collection(collection)
                .where('userId', '==', currentUser.uid)
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();

            return snapshot.docs.map(doc => doc.data());
        }

        function updateEvolutionChart(earnings, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = [];
            const values = [];
            const goalValues = [];

            // Get daily goal
            let dailyGoal = 0;
            db.collection('userGoals').doc(currentUser.uid).get().then(doc => {
                if (doc.exists) {
                    dailyGoal = doc.data().dailyGoal;
                }

                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    days.push(d.getDate() + '/' + (d.getMonth() + 1));

                    const dayEarnings = earnings.filter(e => e.date === dateStr);
                    const total = dayEarnings.reduce((sum, e) => sum + e.amount, 0);
                    values.push(total);
                    goalValues.push(dailyGoal);
                }

                const ctx = document.getElementById('evolutionChart');
                if (evolutionChart) evolutionChart.destroy();

                evolutionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: days,
                        datasets: [
                            {
                                label: 'Ganhos Di√°rios',
                                data: values,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Meta Di√°ria',
                                data: goalValues,
                                borderColor: '#f59e0b',
                                backgroundColor: 'transparent',
                                borderDash: [5, 5],
                                tension: 0,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            });
        }

        // PDF Export
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.text('Relat√≥rio Financeiro', 20, 20);
            doc.setFontSize(12);
            doc.text(`Per√≠odo: ${document.getElementById('periodFilter').options[document.getElementById('periodFilter').selectedIndex].text}`, 20, 30);
            doc.text(`Ganhos: ${document.getElementById('totalEarnings').textContent}`, 20, 40);
            doc.text(`Despesas: ${document.getElementById('totalExpenses').textContent}`, 20, 50);
            doc.text(`Lucro: ${document.getElementById('profit').textContent}`, 20, 60);
            doc.text(`Casa: ${document.getElementById('totalHouse').textContent}`, 20, 70);
            doc.text(`Saldo Final: ${document.getElementById('finalBalance').textContent}`, 20, 80);

            doc.save('relatorio-financeiro.pdf');
        }

        // Initialize month selector on change
        document.getElementById('weeklyGoalMonth').addEventListener('change', function() {
            generateWeekSelector(this.value);
        });
    </script>
</body>
</html>
