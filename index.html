<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gest√£o Financeira - Gordinho do Comfort</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .card {
      @apply bg-white border border-slate-200 rounded-xl p-5 shadow-sm;
    }
    .card-label {
      @apply text-xs text-slate-500 mb-1 font-medium uppercase tracking-wide;
    }
    .card-value {
      @apply text-2xl sm:text-3xl font-bold text-slate-900;
    }
    .label {
      @apply block text-sm text-slate-700 mb-1.5 font-medium;
    }
    .input {
      @apply w-full rounded-lg bg-white border border-slate-300 text-sm px-3 py-2.5 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent;
    }
    .btn-primary {
      @apply px-4 py-2.5 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition shadow-sm;
    }
    .btn-secondary {
      @apply px-4 py-2.5 rounded-lg bg-white text-slate-700 text-sm font-medium border border-slate-300 hover:bg-slate-50 transition;
    }
    .btn-danger {
      @apply px-2 py-1 rounded text-xs font-medium bg-red-50 text-red-600 hover:bg-red-100 transition;
    }
    .tab-btn {
      @apply px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition;
    }
    .tab-active {
      @apply bg-emerald-50 text-emerald-700 font-semibold;
    }
    .section-title {
      @apply text-lg font-bold text-slate-900 mb-1;
    }
    .section-subtitle {
      @apply text-sm text-slate-500 mb-4;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

  <!-- HEADER -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
    <div class="max-w-6xl mx-auto flex items-center justify-between px-4 sm:px-6 py-4">
      <div class="flex items-center gap-3">
        <img
          id="logoImg"
          src=""
          alt="Logo"
          class="w-12 h-12 rounded-full border-2 border-emerald-500 shadow-md object-cover hidden"
        />
        <div>
          <h1 class="text-xl sm:text-2xl font-bold text-slate-900">
            Gest√£o Financeira
          </h1>
          <p class="text-xs text-slate-500">
            Gordinho do Comfort
          </p>
        </div>
      </div>

      <button
        id="logoutBtn"
        class="hidden sm:inline-flex px-4 py-2 rounded-lg text-sm font-medium bg-slate-100 text-slate-700 hover:bg-slate-200 transition"
      >
        Sair
      </button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-6 sm:py-8">

      <!-- LOGIN -->
      <section id="authSection" class="max-w-md mx-auto mt-12">
        <div class="bg-white border border-slate-200 rounded-2xl shadow-lg p-8">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-slate-900 mb-2">
              Bem-vindo de volta
            </h2>
            <p class="text-sm text-slate-500">
              Acesse sua conta para continuar
            </p>
          </div>

          <div class="space-y-4 mb-6">
            <div>
              <label class="label">E-mail</label>
              <input
                id="emailInput"
                type="email"
                class="input"
                placeholder="seu@email.com"
              />
            </div>
            <div>
              <label class="label">Senha</label>
              <input
                id="passwordInput"
                type="password"
                class="input"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              />
            </div>
          </div>

          <button id="loginBtn" class="w-full btn-primary mb-3">
            Entrar
          </button>
          <button id="registerBtn" class="w-full btn-secondary mb-3">
            Criar nova conta
          </button>
          <button id="forgotPasswordBtn" class="w-full text-sm text-emerald-600 hover:text-emerald-700 font-medium">
            Esqueci minha senha
          </button>
        </div>
      </section>

      <!-- APP -->
      <section id="appSection" class="hidden space-y-6">

        <!-- TABS -->
        <nav class="bg-white border border-slate-200 rounded-xl p-2 flex flex-wrap gap-1 shadow-sm">
          <button data-tab="dashboard" class="tab-btn tab-active flex-1 sm:flex-none">
            üìä Dashboard
          </button>
          <button data-tab="earnings" class="tab-btn flex-1 sm:flex-none">
            üí∞ Ganhos
          </button>
          <button data-tab="goals" class="tab-btn flex-1 sm:flex-none">
            üéØ Metas
          </button>
          <button data-tab="work" class="tab-btn flex-1 sm:flex-none">
            üöó Trabalho
          </button>
          <button data-tab="home" class="tab-btn flex-1 sm:flex-none">
            üè† Casa
          </button>
          <button
            id="logoutBtnMobile"
            class="sm:hidden ml-auto px-3 py-2 rounded-lg text-xs font-medium bg-slate-100 text-slate-700"
          >
            Sair
          </button>
        </nav>

        <!-- DASHBOARD -->
        <section id="tab-dashboard" class="tab-panel space-y-6">

          <!-- Filtro de per√≠odo (dropdown) -->
          <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
            <label class="label">Per√≠odo</label>
            <select id="periodSelect" class="input">
              <option value="last7">√öltima Semana</option>
              <option value="month">M√™s Atual</option>
              <option value="prevMonth">M√™s Anterior</option>
              <option value="year">Ano Todo</option>
            </select>
          </div>

          <!-- Cards principais -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="card">
              <p class="card-label">Ganhos</p>
              <p id="totalEarningsDisplay" class="card-value text-emerald-600">R$ 0,00</p>
            </div>
            <div class="card">
              <p class="card-label">Despesas Trabalho</p>
              <p id="totalWorkExpensesDisplay" class="card-value text-orange-600">R$ 0,00</p>
            </div>
            <div class="card">
              <p class="card-label">Despesas Casa</p>
              <p id="totalHouseExpensesDisplay" class="card-value text-blue-600">R$ 0,00</p>
            </div>
            <div class="card">
              <p class="card-label">Lucro</p>
              <p id="profitDisplay" class="card-value text-emerald-700">R$ 0,00</p>
            </div>
            <div class="card">
              <p class="card-label">Saldo Final</p>
              <p id="finalBalanceDisplay" class="card-value">R$ 0,00</p>
            </div>
            <div class="card">
              <p class="card-label">Meta Di√°ria</p>
              <p id="currentDailyGoalDisplay" class="card-value text-purple-600">R$ 0,00</p>
            </div>
          </div>

          <!-- Gr√°fico -->
          <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
            <h3 class="section-title">Evolu√ß√£o de Ganhos (M√™s Atual)</h3>
            <canvas id="earningsChart" class="w-full h-64"></canvas>
          </div>
        </section>

        <!-- GANHOS -->
        <section id="tab-earnings" class="tab-panel hidden space-y-4">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="section-title">Ganhos Di√°rios</h3>
              <p class="section-subtitle">Registre seus ganhos por plataforma</p>
            </div>
            <button
              id="openEarningsModalBtn"
              class="btn-primary"
            >
              + Adicionar
            </button>
          </div>

          <ul id="earningsList" class="space-y-2">
            <!-- via JS -->
          </ul>
        </section>

        <!-- METAS -->
        <section id="tab-goals" class="tab-panel hidden space-y-4">
          <div>
            <h3 class="section-title">Metas</h3>
            <p class="section-subtitle">Configure suas metas mensais e semanais</p>
          </div>

          <div class="card space-y-4">
            <h4 class="text-base font-semibold text-slate-900">Meta Mensal</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="label">M√™s</label>
                <input id="monthlyGoalMonth" type="month" class="input" />
              </div>
              <div>
                <label class="label">Valor (R$)</label>
                <input
                  id="monthlyGoalValue"
                  type="number"
                  min="0"
                  step="0.01"
                  class="input"
                  placeholder="6000"
                />
              </div>
            </div>
            <button id="saveMonthlyGoalBtn" class="btn-primary">
              Salvar Meta Mensal
            </button>
          </div>

          <div class="card space-y-4">
            <h4 class="text-base font-semibold text-slate-900">Meta Semanal</h4>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div>
                <label class="label">M√™s</label>
                <input id="weeklyGoalMonth" type="month" class="input" />
              </div>
              <div>
                <label class="label">Semanas</label>
                <select id="weeklyGoalWeeks" class="input" multiple>
                  <option value="1">Semana 1</option>
                  <option value="2">Semana 2</option>
                  <option value="3">Semana 3</option>
                  <option value="4">Semana 4</option>
                  <option value="5">Semana 5</option>
                </select>
              </div>
              <div>
                <label class="label">Valor (R$)</label>
                <input
                  id="weeklyGoalValue"
                  type="number"
                  min="0"
                  step="0.01"
                  class="input"
                  placeholder="1500"
                />
              </div>
            </div>
            <button id="saveWeeklyGoalBtn" class="btn-primary">
              Salvar Meta Semanal
            </button>
          </div>

          <div class="card">
            <p class="text-sm text-slate-500 mb-2">Meta Di√°ria Calculada</p>
            <p id="goalsCurrentDailyDisplay" class="text-3xl font-bold text-purple-600">
              R$ 0,00
            </p>
          </div>
        </section>

        <!-- TRABALHO -->
        <section id="tab-work" class="tab-panel hidden space-y-4">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="section-title">Despesas de Trabalho</h3>
              <p class="section-subtitle">Combust√≠vel, manuten√ß√£o, ped√°gio, etc.</p>
            </div>
            <button
              id="openWorkExpenseModalBtn"
              class="btn-primary"
            >
              + Adicionar
            </button>
          </div>

          <ul id="workExpensesList" class="space-y-2">
            <!-- via JS -->
          </ul>
        </section>

        <!-- CASA -->
        <section id="tab-home" class="tab-panel hidden space-y-4">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="section-title">Despesas de Casa</h3>
              <p class="section-subtitle">Aluguel, contas fixas, mercado, etc.</p>
            </div>
            <button
              id="openHouseExpenseModalBtn"
              class="btn-primary"
            >
              + Adicionar
            </button>
          </div>

          <ul id="houseExpensesList" class="space-y-2">
            <!-- via JS -->
          </ul>
        </section>
      </section>
    </div>
  </main>

  <!-- MODAL GANHOS -->
  <div id="earningsModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
      <h3 class="text-lg font-bold text-slate-900 mb-4">
        Adicionar Ganho
      </h3>

      <div class="space-y-3 mb-5">
        <div>
          <label class="label">Data</label>
          <input id="earningsDate" type="date" class="input" />
        </div>
        <div>
          <label class="label">Plataforma</label>
          <select id="earningsPlatform" class="input">
            <option value="Uber">Uber</option>
            <option value="99">99</option>
            <option value="InDriver">InDriver</option>
            <option value="Outros">Outros</option>
          </select>
        </div>
        <div>
          <label class="label">Valor (R$)</label>
          <input id="earningsAmount" type="number" min="0" step="0.01" class="input" placeholder="150.00" />
        </div>
        <div>
          <label class="label">Observa√ß√µes (opcional)</label>
          <textarea id="earningsNotes" rows="2" class="input" placeholder="Ex.: dia fraco, chuva"></textarea>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="cancelEarningsBtn" class="flex-1 btn-secondary">Cancelar</button>
        <button id="saveEarningsBtn" class="flex-1 btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DESPESA TRABALHO -->
  <div id="workExpenseModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
      <h3 class="text-lg font-bold text-slate-900 mb-4">
        Adicionar Despesa de Trabalho
      </h3>

      <div class="space-y-3 mb-5">
        <div>
          <label class="label">Data</label>
          <input id="workExpenseDate" type="date" class="input" />
        </div>
        <div>
          <label class="label">Categoria</label>
          <select id="workExpenseCategory" class="input">
            <option value="Combust√≠vel">Combust√≠vel</option>
            <option value="Manuten√ß√£o">Manuten√ß√£o</option>
            <option value="Lavagem">Lavagem</option>
            <option value="Ped√°gio">Ped√°gio</option>
            <option value="Estacionamento">Estacionamento</option>
            <option value="Outros">Outros</option>
          </select>
        </div>
        <div>
          <label class="label">Valor (R$)</label>
          <input id="workExpenseAmount" type="number" min="0" step="0.01" class="input" placeholder="50.00" />
        </div>
        <div>
          <label class="label">Descri√ß√£o (opcional)</label>
          <textarea id="workExpenseDescription" rows="2" class="input" placeholder="Ex.: troca de √≥leo"></textarea>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="cancelWorkExpenseBtn" class="flex-1 btn-secondary">Cancelar</button>
        <button id="saveWorkExpenseBtn" class="flex-1 btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DESPESA CASA -->
  <div id="houseExpenseModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
      <h3 class="text-lg font-bold text-slate-900 mb-4">
        Adicionar Despesa de Casa
      </h3>

      <div class="space-y-3 mb-5">
        <div>
          <label class="label">Data</label>
          <input id="houseExpenseDate" type="date" class="input" />
        </div>
        <div>
          <label class="label">Categoria</label>
          <select id="houseExpenseCategory" class="input">
            <option value="Aluguel">Aluguel</option>
            <option value="√Ågua">√Ågua</option>
            <option value="Luz">Luz</option>
            <option value="Internet">Internet</option>
            <option value="Mercado">Mercado</option>
            <option value="Outros">Outros</option>
          </select>
        </div>
        <div>
          <label class="label">Valor (R$)</label>
          <input id="houseExpenseAmount" type="number" min="0" step="0.01" class="input" placeholder="800.00" />
        </div>
        <div>
          <label class="label">Descri√ß√£o (opcional)</label>
          <textarea id="houseExpenseDescription" rows="2" class="input" placeholder="Ex.: aluguel de janeiro"></textarea>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="cancelHouseExpenseBtn" class="flex-1 btn-secondary">Cancelar</button>
        <button id="saveHouseExpenseBtn" class="flex-1 btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- FIREBASE + L√ìGICA -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      setDoc,
      doc,
      getDoc,
      getDocs,
      deleteDoc,
      query,
      where,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDWMlDtQ1dhvE3mLYhRakJ1oM8TJyJd6s8",
      authDomain: "gestao-motorista-4155f.firebaseapp.com",
      projectId: "gestao-motorista-4155f",
      storageBucket: "gestao-motorista-4155f.appspot.com",
      messagingSenderId: "566057933394",
      appId: "1:566057933394:web:afafa56f71557758b11d8b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const safeNumber = (value) => {
      const n = Number(value);
      return isNaN(n) ? 0 : n;
    };

    const formatCurrency = (value) => {
      const n = safeNumber(value);
      return "R$ " + n.toFixed(2).replace(".", ",");
    };

    const todayISO = () => new Date().toISOString().split("T")[0];

    const authSection = document.getElementById("authSection");
    const appSection = document.getElementById("appSection");
    const logoutBtn = document.getElementById("logoutBtn");
    const logoutBtnMobile = document.getElementById("logoutBtnMobile");
    const logoImg = document.getElementById("logoImg");

    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const forgotPasswordBtn = document.getElementById("forgotPasswordBtn");

    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanels = {
      dashboard: document.getElementById("tab-dashboard"),
      earnings: document.getElementById("tab-earnings"),
      goals: document.getElementById("tab-goals"),
      work: document.getElementById("tab-work"),
      home: document.getElementById("tab-home")
    };

    const periodSelect = document.getElementById("periodSelect");

    const totalEarningsDisplay = document.getElementById("totalEarningsDisplay");
    const totalWorkExpensesDisplay = document.getElementById("totalWorkExpensesDisplay");
    const totalHouseExpensesDisplay = document.getElementById("totalHouseExpensesDisplay");
    const profitDisplay = document.getElementById("profitDisplay");
    const finalBalanceDisplay = document.getElementById("finalBalanceDisplay");
    const currentDailyGoalDisplay = document.getElementById("currentDailyGoalDisplay");

    const monthlyGoalMonth = document.getElementById("monthlyGoalMonth");
    const monthlyGoalValue = document.getElementById("monthlyGoalValue");
    const weeklyGoalMonth = document.getElementById("weeklyGoalMonth");
    const weeklyGoalWeeks = document.getElementById("weeklyGoalWeeks");
    const weeklyGoalValue = document.getElementById("weeklyGoalValue");
    const goalsCurrentDailyDisplay = document.getElementById("goalsCurrentDailyDisplay");

    const earningsList = document.getElementById("earningsList");
    const workExpensesList = document.getElementById("workExpensesList");
    const houseExpensesList = document.getElementById("houseExpensesList");

    const earningsModal = document.getElementById("earningsModal");
    const earningsDate = document.getElementById("earningsDate");
    const earningsPlatform = document.getElementById("earningsPlatform");
    const earningsAmount = document.getElementById("earningsAmount");
    const earningsNotes = document.getElementById("earningsNotes");
    const openEarningsModalBtn = document.getElementById("openEarningsModalBtn");
    const saveEarningsBtn = document.getElementById("saveEarningsBtn");
    const cancelEarningsBtn = document.getElementById("cancelEarningsBtn");

    const workExpenseModal = document.getElementById("workExpenseModal");
    const workExpenseDate = document.getElementById("workExpenseDate");
    const workExpenseCategory = document.getElementById("workExpenseCategory");
    const workExpenseAmount = document.getElementById("workExpenseAmount");
    const workExpenseDescription = document.getElementById("workExpenseDescription");
    const openWorkExpenseModalBtn = document.getElementById("openWorkExpenseModalBtn");
    const saveWorkExpenseBtn = document.getElementById("saveWorkExpenseBtn");
    const cancelWorkExpenseBtn = document.getElementById("cancelWorkExpenseBtn");

    const houseExpenseModal = document.getElementById("houseExpenseModal");
    const houseExpenseDate = document.getElementById("houseExpenseDate");
    const houseExpenseCategory = document.getElementById("houseExpenseCategory");
    const houseExpenseAmount = document.getElementById("houseExpenseAmount");
    const houseExpenseDescription = document.getElementById("houseExpenseDescription");
    const openHouseExpenseModalBtn = document.getElementById("openHouseExpenseModalBtn");
    const saveHouseExpenseBtn = document.getElementById("saveHouseExpenseBtn");
    const cancelHouseExpenseBtn = document.getElementById("cancelHouseExpenseBtn");

    const saveMonthlyGoalBtn = document.getElementById("saveMonthlyGoalBtn");
    const saveWeeklyGoalBtn = document.getElementById("saveWeeklyGoalBtn");

    // Carregar logo
    const logoUrl = "https://raw.githubusercontent.com/eduardoeff/gestao-financeira-motorista/main/logo-gordinho-comfort.png";
    logoImg.src = logoUrl;
    logoImg.onload = () => logoImg.classList.remove("hidden");
    logoImg.onerror = () => console.warn("Logo n√£o encontrada");

    // Auth
    loginBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        alert("Informe e-mail e senha.");
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        console.error("Erro ao entrar:", error);
        alert("Erro ao entrar: " + (error.message || "Verifique e-mail e senha."));
      }
    });

    registerBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        alert("Informe e-mail e senha.");
        return;
      }
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("Conta criada com sucesso!");
      } catch (error) {
        console.error("Erro ao criar conta:", error);
        alert("Erro ao criar conta: " + (error.message || ""));
      }
    });

    forgotPasswordBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      if (!email) {
        alert("Digite seu e-mail no campo acima.");
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        alert("E-mail de recupera√ß√£o enviado! Verifique sua caixa de entrada.");
      } catch (error) {
        console.error("Erro ao enviar e-mail:", error);
        alert("Erro ao enviar e-mail de recupera√ß√£o: " + (error.message || ""));
      }
    });

    const doLogout = async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error("Erro ao sair:", error);
      }
    };

    logoutBtn.addEventListener("click", doLogout);
    logoutBtnMobile.addEventListener("click", doLogout);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        initForUser(user);
      } else {
        authSection.classList.remove("hidden");
        appSection.classList.add("hidden");
      }
    });

    // Tabs
    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        tabButtons.forEach((b) => b.classList.remove("tab-active"));
        btn.classList.add("tab-active");

        Object.entries(tabPanels).forEach(([key, panel]) => {
          panel.classList.toggle("hidden", key !== tab);
        });
      });
    });

    // Modais
    const openModal = (el) => el.classList.remove("hidden");
    const closeModal = (el) => el.classList.add("hidden");

    openEarningsModalBtn?.addEventListener("click", () => {
      earningsDate.value = todayISO();
      earningsAmount.value = "";
      earningsNotes.value = "";
      openModal(earningsModal);
    });
    cancelEarningsBtn?.addEventListener("click", () => closeModal(earningsModal));

    openWorkExpenseModalBtn?.addEventListener("click", () => {
      workExpenseDate.value = todayISO();
      workExpenseAmount.value = "";
      workExpenseDescription.value = "";
      openModal(workExpenseModal);
    });
    cancelWorkExpenseBtn?.addEventListener("click", () => closeModal(workExpenseModal));

    openHouseExpenseModalBtn?.addEventListener("click", () => {
      houseExpenseDate.value = todayISO();
      houseExpenseAmount.value = "";
      houseExpenseDescription.value = "";
      openModal(houseExpenseModal);
    });
    cancelHouseExpenseBtn?.addEventListener("click", () => closeModal(houseExpenseModal));

    // Salvar Ganhos
    saveEarningsBtn?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) {
        alert("Voc√™ precisa estar logado.");
        return;
      }
      const date = earningsDate.value;
      const platform = earningsPlatform.value;
      const amount = safeNumber(earningsAmount.value);
      const notes = earningsNotes.value || "";

      if (!date || amount <= 0) {
        alert("Informe uma data e um valor maior que zero.");
        return;
      }

      try {
        await addDoc(collection(db, "dailyEarnings"), {
          userId: user.uid,
          date,
          platform,
          amount,
          notes,
          createdAt: serverTimestamp()
        });
        closeModal(earningsModal);
        await loadAllData(user);
      } catch (error) {
        console.error("Erro ao salvar ganhos:", error);
        alert("Erro ao salvar ganhos. Veja o console.");
      }
    });

    // Salvar Despesas
    saveWorkExpenseBtn?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const date = workExpenseDate.value;
      const category = workExpenseCategory.value;
      const amount = safeNumber(workExpenseAmount.value);
      const description = workExpenseDescription.value || "";

      if (!date || amount <= 0) {
        alert("Informe data e valor.");
        return;
      }

      try {
        await addDoc(collection(db, "expenses"), {
          userId: user.uid,
          date,
          category,
          amount,
          description,
          type: "work",
          createdAt: serverTimestamp()
        });
        closeModal(workExpenseModal);
        await loadAllData(user);
      } catch (error) {
        console.error("Erro ao salvar despesa de trabalho:", error);
        alert("Erro ao salvar. Veja o console.");
      }
    });

    saveHouseExpenseBtn?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const date = houseExpenseDate.value;
      const category = houseExpenseCategory.value;
      const amount = safeNumber(houseExpenseAmount.value);
      const description = houseExpenseDescription.value || "";

      if (!date || amount <= 0) {
        alert("Informe data e valor.");
        return;
      }

      try {
        await addDoc(collection(db, "houseExpenses"), {
          userId: user.uid,
          date,
          category,
          amount,
          description,
          createdAt: serverTimestamp()
        });
        closeModal(houseExpenseModal);
        await loadAllData(user);
      } catch (error) {
        console.error("Erro ao salvar despesa de casa:", error);
        alert("Erro ao salvar. Veja o console.");
      }
    });

    // Metas
    const goalsDocRef = (uid) => doc(db, "userGoals", uid);

    saveMonthlyGoalBtn?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const month = monthlyGoalMonth.value;
      const value = safeNumber(monthlyGoalValue.value);

      if (!month || value <= 0) {
        alert("Informe m√™s e valor da meta.");
        return;
      }

      try {
        const ref = goalsDocRef(user.uid);
        const snap = await getDoc(ref);
        const data = snap.exists() ? snap.data() : {};
        const monthlyGoals = data.monthlyGoals || {};
        monthlyGoals[month] = value;

        await setDoc(ref, { ...data, monthlyGoals }, { merge: true });
        await loadGoals(user);
        alert("Meta mensal salva.");
      } catch (error) {
        console.error("Erro ao salvar meta mensal:", error);
        alert("Erro ao salvar meta mensal.");
      }
    });

    saveWeeklyGoalBtn?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const month = weeklyGoalMonth.value;
      const value = safeNumber(weeklyGoalValue.value);
      const selectedWeeks = Array.from(weeklyGoalWeeks.selectedOptions).map((o) =>
        Number(o.value)
      );

      if (!month || value <= 0 || selectedWeeks.length === 0) {
        alert("Informe m√™s, semanas e valor.");
        return;
      }

      try {
        const ref = goalsDocRef(user.uid);
        const snap = await getDoc(ref);
        const data = snap.exists() ? snap.data() : {};
        const weeklyGoals = data.weeklyGoals || {};

        const key = `${month}-${selectedWeeks.join(",")}`;
        weeklyGoals[key] = { value, weeks: selectedWeeks };

        await setDoc(ref, { ...data, weeklyGoals }, { merge: true });
        await loadGoals(user);
        alert("Meta semanal salva.");
      } catch (error) {
        console.error("Erro ao salvar meta semanal:", error);
        alert("Erro ao salvar meta semanal.");
      }
    });

    // Dashboard
    let earningsChart;

    function setupChart(labels, values) {
      const ctx = document.getElementById("earningsChart").getContext("2d");
      if (earningsChart) earningsChart.destroy();
      earningsChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Ganhos (R$)",
              data: values,
              borderColor: "#059669",
              backgroundColor: "rgba(5,150,105,0.1)",
              tension: 0.3,
              fill: true,
              pointRadius: 4,
              pointBackgroundColor: "#059669"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            x: {
              ticks: { color: "#64748b", font: { size: 11 } }
            },
            y: {
              ticks: {
                color: "#64748b",
                font: { size: 11 },
                callback: (v) => "R$ " + v
              }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    function getPeriodRange(period) {
      const now = new Date();
      const start = new Date();
      const end = new Date();

      if (period === "last7") {
        start.setDate(now.getDate() - 6);
      } else if (period === "month") {
        start.setDate(1);
      } else if (period === "year") {
        start.setMonth(0, 1);
      } else if (period === "prevMonth") {
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const firstDayPrev = new Date(currentYear, currentMonth - 1, 1);
        const lastDayPrev = new Date(currentYear, currentMonth, 0);
        return {
          start: firstDayPrev.toISOString().split("T")[0],
          end: lastDayPrev.toISOString().split("T")[0]
        };
      }
      return {
        start: start.toISOString().split("T")[0],
        end: end.toISOString().split("T")[0]
      };
    }

    periodSelect.addEventListener("change", async () => {
      const user = auth.currentUser;
      if (user) await loadDashboard(user, periodSelect.value);
    });

    async function loadDashboard(user, period = "last7") {
      const { start, end } = getPeriodRange(period);

      try {
        let earningsTotal = 0;
        let earningsCount = 0;
        const earningsByDay = {};
        const earningsQ = query(
          collection(db, "dailyEarnings"),
          where("userId", "==", user.uid),
          where("date", ">=", start),
          where("date", "<=", end),
          orderBy("date", "asc")
        );
        const earningsSnap = await getDocs(earningsQ);
        earningsSnap.forEach((docSnap) => {
          const data = docSnap.data();
          const amount = safeNumber(data.amount);
          const date = data.date;
          earningsTotal += amount;
          earningsCount += 1;
          earningsByDay[date] = (earningsByDay[date] || 0) + amount;
        });

        let workTotal = 0;
        const workQ = query(
          collection(db, "expenses"),
          where("userId", "==", user.uid),
          where("date", ">=", start),
          where("date", "<=", end),
          orderBy("date", "asc")
        );
        const workSnap = await getDocs(workQ);
        workSnap.forEach((docSnap) => {
          workTotal += safeNumber(docSnap.data().amount);
        });

        let houseTotal = 0;
        const houseQ = query(
          collection(db, "houseExpenses"),
          where("userId", "==", user.uid),
          where("date", ">=", start),
          where("date", "<=", end),
          orderBy("date", "asc")
        );
        const houseSnap = await getDocs(houseQ);
        houseSnap.forEach((docSnap) => {
          houseTotal += safeNumber(docSnap.data().amount);
        });

        const profit = earningsTotal - workTotal;
        const finalBalance = profit - houseTotal;

        totalEarningsDisplay.textContent = formatCurrency(earningsTotal);
        totalWorkExpensesDisplay.textContent = formatCurrency(workTotal);
        totalHouseExpensesDisplay.textContent = formatCurrency(houseTotal);
        profitDisplay.textContent = formatCurrency(profit);
        finalBalanceDisplay.textContent = formatCurrency(finalBalance);

        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const lastDay = new Date(year, month + 1, 0).getDate();

        const labels = [];
        const values = [];
        for (let d = 1; d <= lastDay; d++) {
          const dateObj = new Date(year, month, d);
          const key = dateObj.toISOString().split("T")[0];
          labels.push(d.toString());
          values.push(safeNumber(earningsByDay[key] || 0));
        }
        setupChart(labels, values);

        await loadGoals(user, { onlyUpdateDailyGoal: true });
      } catch (error) {
        console.error("Erro ao carregar dashboard:", error);
      }
    }

    async function loadEarningsList(user) {
      earningsList.innerHTML = "";
      try {
        const qE = query(
          collection(db, "dailyEarnings"),
          where("userId", "==", user.uid),
          orderBy("date", "desc")
        );
        const snap = await getDocs(qE);
        if (snap.empty) {
          earningsList.innerHTML =
            '<li class="text-slate-500 text-sm p-4 bg-white border border-slate-200 rounded-lg">Nenhum ganho cadastrado.</li>';
          return;
        }
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const li = document.createElement("li");
          li.className =
            "flex justify-between items-center bg-white border border-slate-200 rounded-lg px-4 py-3 shadow-sm";
          li.innerHTML = `
            <div>
              <p class="font-semibold text-sm text-slate-900">${formatCurrency(d.amount)} ‚Ä¢ ${
            d.platform || "Plataforma"
          }</p>
              <p class="text-xs text-slate-500">${d.date} ${
            d.notes ? "‚Ä¢ " + d.notes : ""
          }</p>
            </div>
            <button class="btn-danger" data-id="${docSnap.id}" data-type="earnings">Excluir</button>
          `;
          earningsList.appendChild(li);
        });
      } catch (error) {
        console.error("Erro ao carregar ganhos:", error);
      }
    }

    async function loadExpensesLists(user) {
      workExpensesList.innerHTML = "";
      houseExpensesList.innerHTML = "";

      try {
        const qWork = query(
          collection(db, "expenses"),
          where("userId", "==", user.uid),
          orderBy("date", "desc")
        );
        const wSnap = await getDocs(qWork);
        if (wSnap.empty) {
          workExpensesList.innerHTML =
            '<li class="text-slate-500 text-sm p-4 bg-white border border-slate-200 rounded-lg">Nenhuma despesa de trabalho.</li>';
        } else {
          wSnap.forEach((docSnap) => {
            const d = docSnap.data();
            const li = document.createElement("li");
            li.className =
              "flex justify-between items-center bg-white border border-slate-200 rounded-lg px-4 py-3 shadow-sm";
            li.innerHTML = `
              <div>
                <p class="font-semibold text-sm text-slate-900">${formatCurrency(
                  d.amount
                )} ‚Ä¢ ${d.category}</p>
                <p class="text-xs text-slate-500">${d.date} ${
              d.description ? "‚Ä¢ " + d.description : ""
            }</p>
              </div>
              <button class="btn-danger" data-id="${docSnap.id}" data-type="work">Excluir</button>
            `;
            workExpensesList.appendChild(li);
          });
        }
      } catch (error) {
        console.error("Erro ao carregar despesas de trabalho:", error);
      }

      try {
        const qHouse = query(
          collection(db, "houseExpenses"),
          where("userId", "==", user.uid),
          orderBy("date", "desc")
        );
        const hSnap = await getDocs(qHouse);
        if (hSnap.empty) {
          houseExpensesList.innerHTML =
            '<li class="text-slate-500 text-sm p-4 bg-white border border-slate-200 rounded-lg">Nenhuma despesa de casa.</li>';
        } else {
          hSnap.forEach((docSnap) => {
            const d = docSnap.data();
            const li = document.createElement("li");
            li.className =
              "flex justify-between items-center bg-white border border-slate-200 rounded-lg px-4 py-3 shadow-sm";
            li.innerHTML = `
              <div>
                <p class="font-semibold text-sm text-slate-900">${formatCurrency(
                  d.amount
                )} ‚Ä¢ ${d.category}</p>
                <p class="text-xs text-slate-500">${d.date} ${
              d.description ? "‚Ä¢ " + d.description : ""
            }</p>
              </div>
              <button class="btn-danger" data-id="${docSnap.id}" data-type="house">Excluir</button>
            `;
            houseExpensesList.appendChild(li);
          });
        }
      } catch (error) {
        console.error("Erro ao carregar despesas de casa:", error);
      }
    }

    // Excluir item
    document.addEventListener("click", async (e) => {
      if (e.target.classList.contains("btn-danger")) {
        const id = e.target.getAttribute("data-id");
        const type = e.target.getAttribute("data-type");
        if (!id || !type) return;

        if (!confirm("Tem certeza que deseja excluir este item?")) return;

        try {
          if (type === "earnings") {
            await deleteDoc(doc(db, "dailyEarnings", id));
          } else if (type === "work") {
            await deleteDoc(doc(db, "expenses", id));
          } else if (type === "house") {
            await deleteDoc(doc(db, "houseExpenses", id));
          }
          const user = auth.currentUser;
          if (user) await loadAllData(user);
        } catch (error) {
          console.error("Erro ao excluir:", error);
          alert("Erro ao excluir item.");
        }
      }
    });

    async function loadGoals(user, options = {}) {
      const ref = goalsDocRef(user.uid);
      const snap = await getDoc(ref);
      let monthlyGoals = {};
      let weeklyGoals = {};

      if (snap.exists()) {
        const data = snap.data();
        monthlyGoals = data.monthlyGoals || {};
        weeklyGoals = data.weeklyGoals || {};
      }

      const currentMonthStr = new Date().toISOString().slice(0, 7);

      if (!options.onlyUpdateDailyGoal) {
        monthlyGoalMonth.value = currentMonthStr;
        weeklyGoalMonth.value = currentMonthStr;

        const monthValue = monthlyGoals[currentMonthStr] || 0;
        monthlyGoalValue.value = monthValue > 0 ? monthValue : "";

        const weeklyEntry = Object.entries(weeklyGoals).find(([key]) =>
          key.startsWith(currentMonthStr + "-")
        );
        if (weeklyEntry) {
          const [key, val] = weeklyEntry;
          weeklyGoalValue.value = val.value || "";
        } else {
          weeklyGoalValue.value = "";
        }
      }

      let dailyGoal = 0;
      const weeklyForCurrent = Object.entries(weeklyGoals).find(([key]) =>
        key.startsWith(currentMonthStr + "-")
      );
      if (weeklyForCurrent) {
        const [key, val] = weeklyForCurrent;
        const weeks = val.weeks || [];
        const days = weeks.length * 7 || 1;
        dailyGoal = safeNumber(val.value) / days;
      } else if (monthlyGoals[currentMonthStr]) {
        const value = safeNumber(monthlyGoals[currentMonthStr]);
        const daysInMonth = new Date(
          new Date().getFullYear(),
          new Date().getMonth() + 1,
          0
        ).getDate();
        dailyGoal = value / daysInMonth;
      }

      currentDailyGoalDisplay.textContent = formatCurrency(dailyGoal);
      goalsCurrentDailyDisplay.textContent = formatCurrency(dailyGoal);
    }

    async function loadAllData(user) {
      await Promise.all([
        loadDashboard(user, periodSelect.value),
        loadEarningsList(user),
        loadExpensesLists(user),
        loadGoals(user)
      ]);
    }

    function initForUser(user) {
      periodSelect.value = "last7";
      loadAllData(user);
    }
  </script>
</body>
</html>
