<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gest√£o Financeira Inteligente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root" class="min-h-screen flex items-center justify-center">
    <div class="text-center text-gray-600">
      Carregando aplica√ß√£o...
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyBjvoL-4ea23mDnuH6Cq65yXtWkKvj9EEU",
      authDomain: "gestao-motorista-4155f.firebaseapp.com",
      projectId: "gestao-motorista-4155f",
      storageBucket: "gestao-motorista-4155f.firebasestorage.app",
      messagingSenderId: "566057933394",
      appId: "1:566057933394:web:afafa56f71557758b11d8b"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [authMode, setAuthMode] = useState('login');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [authError, setAuthError] = useState('');

      const [activeTab, setActiveTab] = useState('dashboard');
      const [dailyEarnings, setDailyEarnings] = useState([]);
      const [expenses, setExpenses] = useState([]);
      const [houseExpenses, setHouseExpenses] = useState([]);
      const [customPlatforms, setCustomPlatforms] = useState([]);

      const [showEarningModal, setShowEarningModal] = useState(false);
      const [showExpenseModal, setShowExpenseModal] = useState(false);
      const [showHouseModal, setShowHouseModal] = useState(false);

      const [filterPeriod, setFilterPeriod] = useState('month'); // week, month, year, all

      const chartRef = useRef(null);
      const chartInstance = useRef(null);
      const barChartRef = useRef(null);
      const barChartInstance = useRef(null);

      const today = new Date().toISOString().split('T')[0];

      const defaultPlatforms = ['Uber', '99', 'InDrive'];

      const [earningForm, setEarningForm] = useState({
        date: today,
        platform: 'Uber',
        customPlatform: '',
        value: ''
      });

      const [expenseForm, setExpenseForm] = useState({
        date: today,
        category: 'Combust√≠vel',
        description: '',
        value: ''
      });

      const [houseForm, setHouseForm] = useState({
        date: today,
        category: 'Alimenta√ß√£o',
        description: '',
        value: ''
      });

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((currentUser) => {
          setUser(currentUser);
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (!user) return;

        const earningsQuery = db
          .collection('dailyEarnings')
          .where('userId', '==', user.uid)
          .orderBy('date', 'desc');

        const unsubEarnings = earningsQuery.onSnapshot((snapshot) => {
          const data = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            value: parseFloat(doc.data().value) || 0
          }));
          setDailyEarnings(data);
        });

        const expensesQuery = db
          .collection('expenses')
          .where('userId', '==', user.uid)
          .orderBy('date', 'desc');

        const unsubExpenses = expensesQuery.onSnapshot((snapshot) => {
          const data = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            value: parseFloat(doc.data().value) || 0
          }));
          setExpenses(data);
        });

        const houseQuery = db
          .collection('houseExpenses')
          .where('userId', '==', user.uid)
          .orderBy('date', 'desc');

        const unsubHouse = houseQuery.onSnapshot((snapshot) => {
          const data = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            value: parseFloat(doc.data().value) || 0
          }));
          setHouseExpenses(data);
        });

        const platformsQuery = db
          .collection('customPlatforms')
          .where('userId', '==', user.uid);

        const unsubPlatforms = platformsQuery.onSnapshot((snapshot) => {
          const data = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setCustomPlatforms(data);
        });

        return () => {
          unsubEarnings();
          unsubExpenses();
          unsubHouse();
          unsubPlatforms();
        };
      }, [user]);

      const handleAuth = async (e) => {
        e.preventDefault();
        setAuthError('');
        try {
          if (authMode === 'login') {
            await auth.signInWithEmailAndPassword(email, password);
          } else {
            await auth.createUserWithEmailAndPassword(email, password);
          }
        } catch (error) {
          if (error.code === 'auth/email-already-in-use') {
            setAuthError('Este e-mail j√° est√° cadastrado');
          } else if (error.code === 'auth/weak-password') {
            setAuthError('A senha deve ter pelo menos 6 caracteres');
          } else if (error.code === 'auth/invalid-email') {
            setAuthError('E-mail inv√°lido');
          } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
            setAuthError('E-mail ou senha incorretos');
          } else {
            setAuthError('Erro ao autenticar. Tente novamente.');
          }
        }
      };

      const handleLogout = async () => {
        await auth.signOut();
      };

      const addEarning = async () => {
        if (!earningForm.value || !user) return;
        
        const finalPlatform = earningForm.platform === 'Outra' 
          ? earningForm.customPlatform.trim() 
          : earningForm.platform;

        if (!finalPlatform) {
          alert('Por favor, informe a plataforma');
          return;
        }

        // Se for uma plataforma customizada nova, salvar na lista
        if (earningForm.platform === 'Outra' && earningForm.customPlatform.trim()) {
          const platformExists = customPlatforms.some(p => 
            p.name.toLowerCase() === earningForm.customPlatform.trim().toLowerCase()
          );
          
          if (!platformExists) {
            await db.collection('customPlatforms').add({
              name: earningForm.customPlatform.trim(),
              userId: user.uid,
              createdAt: new Date().toISOString()
            });
          }
        }
        
        await db.collection('dailyEarnings').add({
          date: earningForm.date,
          platform: finalPlatform,
          value: parseFloat(earningForm.value) || 0,
          userId: user.uid,
          createdAt: new Date().toISOString()
        });
        
        setEarningForm({ date: today, platform: 'Uber', customPlatform: '', value: '' });
        setShowEarningModal(false);
      };

      const addExpense = async () => {
        if (!expenseForm.value || !user) return;
        await db.collection('expenses').add({
          ...expenseForm,
          value: parseFloat(expenseForm.value) || 0,
          userId: user.uid,
          createdAt: new Date().toISOString()
        });
        setExpenseForm({ date: today, category: 'Combust√≠vel', description: '', value: '' });
        setShowExpenseModal(false);
      };

      const addHouseExpense = async () => {
        if (!houseForm.value || !user) return;
        await db.collection('houseExpenses').add({
          ...houseForm,
          value: parseFloat(houseForm.value) || 0,
          userId: user.uid,
          createdAt: new Date().toISOString()
        });
        setHouseForm({ date: today, category: 'Alimenta√ß√£o', description: '', value: '' });
        setShowHouseModal(false);
      };

      const deleteEarning = async (id) => {
        await db.collection('dailyEarnings').doc(id).delete();
      };

      const deleteExpense = async (id) => {
        await db.collection('expenses').doc(id).delete();
      };

      const deleteHouseExpense = async (id) => {
        await db.collection('houseExpenses').doc(id).delete();
      };

      const deleteCustomPlatform = async (id) => {
        await db.collection('customPlatforms').doc(id).delete();
      };

      // Filtrar dados por per√≠odo
      const getFilteredData = (data) => {
        const now = new Date();
        return data.filter(item => {
          const itemDate = new Date(item.date);
          if (filterPeriod === 'week') {
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            return itemDate >= weekAgo;
          } else if (filterPeriod === 'month') {
            return itemDate.getMonth() === now.getMonth() && itemDate.getFullYear() === now.getFullYear();
          } else if (filterPeriod === 'year') {
            return itemDate.getFullYear() === now.getFullYear();
          }
          return true; // all
        });
      };

      const filteredEarnings = getFilteredData(dailyEarnings);
      const filteredExpenses = getFilteredData(expenses);
      const filteredHouseExpenses = getFilteredData(houseExpenses);

      const safeSum = (arr) =>
        arr.reduce((sum, item) => sum + (isNaN(item.value) ? 0 : item.value), 0);

      const totalEarnings = safeSum(filteredEarnings);
      const totalExpenses = safeSum(filteredExpenses);
      const totalHouseExpenses = safeSum(filteredHouseExpenses);
      const workProfit = totalEarnings - totalExpenses;
      const finalBalance = workProfit - totalHouseExpenses;

      const totalDays = filteredEarnings.length;
      const ticketMedio = totalDays > 0 ? totalEarnings / totalDays : 0;
      const custoPorDia = totalDays > 0 ? totalExpenses / totalDays : 0;
      const margemLucro = totalEarnings > 0 ? (workProfit / totalEarnings) * 100 : 0;

      // Compara√ß√£o m√™s atual vs anterior
      const getCurrentMonthData = (data) => {
        const now = new Date();
        return data.filter(item => {
          const d = new Date(item.date);
          return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });
      };

      const getLastMonthData = (data) => {
        const now = new Date();
        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        return data.filter(item => {
          const d = new Date(item.date);
          return d.getMonth() === lastMonth.getMonth() && d.getFullYear() === lastMonth.getFullYear();
        });
      };

      const currentMonthEarnings = safeSum(getCurrentMonthData(dailyEarnings));
      const lastMonthEarnings = safeSum(getLastMonthData(dailyEarnings));
      const earningsDiff = currentMonthEarnings - lastMonthEarnings;
      const earningsDiffPercent = lastMonthEarnings > 0 ? (earningsDiff / lastMonthEarnings) * 100 : 0;

      const currentMonthProfit = safeSum(getCurrentMonthData(dailyEarnings)) - safeSum(getCurrentMonthData(expenses));
      const lastMonthProfit = safeSum(getLastMonthData(dailyEarnings)) - safeSum(getLastMonthData(expenses));
      const profitDiff = currentMonthProfit - lastMonthProfit;
      const profitDiffPercent = lastMonthProfit > 0 ? (profitDiff / lastMonthProfit) * 100 : 0;

      // Gr√°fico de evolu√ß√£o (√∫ltimos 7 dias)
      const getLast7Days = () => {
        const days = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          days.push(d.toISOString().split('T')[0]);
        }
        return days;
      };

      const last7Days = getLast7Days();

      const chartData = last7Days.map(date => {
        const dayEarnings = dailyEarnings.filter(r => r.date === date);
        const dayExpenses = expenses.filter(e => e.date === date);
        const receita = safeSum(dayEarnings);
        const despesa = safeSum(dayExpenses);
        const lucro = receita - despesa;
        return { date, receita, despesa, lucro };
      });

      // Proje√ß√µes
      const avgReceitaDiaria = chartData.reduce((sum, d) => sum + d.receita, 0) / 7;
      const avgDespesaDiaria = chartData.reduce((sum, d) => sum + d.despesa, 0) / 7;
      const avgLucroDiario = avgReceitaDiaria - avgDespesaDiaria;

      const diasRestantesMes = () => {
        const hoje = new Date();
        const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        return ultimoDia.getDate() - hoje.getDate();
      };

      const diasRestantes = diasRestantesMes();
      const projecaoReceita = currentMonthEarnings + (avgReceitaDiaria * diasRestantes);
      const projecaoLucro = currentMonthProfit + (avgLucroDiario * diasRestantes);

      // Ganhos por plataforma
      const earningsByPlatform = filteredEarnings.reduce((acc, earning) => {
        const platform = earning.platform || 'N√£o especificado';
        if (!acc[platform]) {
          acc[platform] = 0;
        }
        acc[platform] += earning.value;
        return acc;
      }, {});

      // Renderizar gr√°fico de linha
      useEffect(() => {
        if (activeTab === 'dashboard' && chartRef.current && chartData.length > 0) {
          if (chartInstance.current) {
            chartInstance.current.destroy();
          }

          const ctx = chartRef.current.getContext('2d');
          chartInstance.current = new Chart(ctx, {
            type: 'line',
            data: {
              labels: last7Days.map(d => {
                const [y, m, day] = d.split('-');
                return `${day}/${m}`;
              }),
              datasets: [
                {
                  label: 'Receita',
                  data: chartData.map(d => d.receita),
                  borderColor: '#10b981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  tension: 0.3,
                  fill: true
                },
                {
                  label: 'Despesas',
                  data: chartData.map(d => d.despesa),
                  borderColor: '#f59e0b',
                  backgroundColor: 'rgba(245, 158, 11, 0.1)',
                  tension: 0.3,
                  fill: true
                },
                {
                  label: 'Lucro',
                  data: chartData.map(d => d.lucro),
                  borderColor: '#0ea5e9',
                  backgroundColor: 'rgba(14, 165, 233, 0.1)',
                  tension: 0.3,
                  fill: true
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'bottom',
                  labels: {
                    boxWidth: 12,
                    font: { size: 11 }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return 'R$ ' + value.toFixed(0);
                    }
                  }
                }
              }
            }
          });
        }

        return () => {
          if (chartInstance.current) {
            chartInstance.current.destroy();
          }
        };
      }, [activeTab, chartData]);

      // Renderizar gr√°fico de barras (indicadores + proje√ß√£o)
      useEffect(() => {
        if (activeTab === 'dashboard' && barChartRef.current) {
          if (barChartInstance.current) {
            barChartInstance.current.destroy();
          }

          const ctx = barChartRef.current.getContext('2d');
          barChartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['Ticket M√©dio', 'Custo/Dia', 'Proje√ß√£o Receita', 'Proje√ß√£o Lucro'],
              datasets: [{
                label: 'Valores (R$)',
                data: [ticketMedio, custoPorDia, projecaoReceita, projecaoLucro],
                backgroundColor: [
                  'rgba(16, 185, 129, 0.7)',
                  'rgba(245, 158, 11, 0.7)',
                  'rgba(139, 92, 246, 0.7)',
                  'rgba(14, 165, 233, 0.7)'
                ],
                borderColor: [
                  '#10b981',
                  '#f59e0b',
                  '#8b5cf6',
                  '#0ea5e9'
                ],
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return 'R$ ' + value.toFixed(0);
                    }
                  }
                }
              }
            }
          });
        }

        return () => {
          if (barChartInstance.current) {
            barChartInstance.current.destroy();
          }
        };
      }, [activeTab, ticketMedio, custoPorDia, projecaoReceita, projecaoLucro]);

      // Exportar PDF
      const exportPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text('Relatorio Financeiro', 20, 20);
        
        doc.setFontSize(12);
        doc.text(`Periodo: ${filterPeriod === 'week' ? 'Ultima Semana' : filterPeriod === 'month' ? 'Mes Atual' : filterPeriod === 'year' ? 'Ano Atual' : 'Todos'}`, 20, 30);
        doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 37);

        doc.setFontSize(14);
        doc.text('Resumo Financeiro', 20, 50);
        
        doc.setFontSize(11);
        doc.text(`Receita Total: R$ ${totalEarnings.toFixed(2)}`, 20, 60);
        doc.text(`Despesas Trabalho: R$ ${totalExpenses.toFixed(2)}`, 20, 67);
        doc.text(`Lucro Trabalho: R$ ${workProfit.toFixed(2)}`, 20, 74);
        doc.text(`Despesas Casa: R$ ${totalHouseExpenses.toFixed(2)}`, 20, 81);
        doc.text(`Saldo Final: R$ ${finalBalance.toFixed(2)}`, 20, 88);

        doc.setFontSize(14);
        doc.text('Indicadores', 20, 105);
        
        doc.setFontSize(11);
        doc.text(`Ticket Medio: R$ ${ticketMedio.toFixed(2)}`, 20, 115);
        doc.text(`Custo por Dia: R$ ${custoPorDia.toFixed(2)}`, 20, 122);
        doc.text(`Margem de Lucro: ${margemLucro.toFixed(1)}%`, 20, 129);

        doc.setFontSize(14);
        doc.text('Projecoes do Mes', 20, 145);
        
        doc.setFontSize(11);
        doc.text(`Receita Projetada: R$ ${projecaoReceita.toFixed(2)}`, 20, 155);
        doc.text(`Lucro Projetado: R$ ${projecaoLucro.toFixed(2)}`, 20, 162);

        doc.setFontSize(14);
        doc.text('Comparacao Mensal', 20, 178);
        
        doc.setFontSize(11);
        doc.text(`Receita Mes Atual: R$ ${currentMonthEarnings.toFixed(2)}`, 20, 188);
        doc.text(`Receita Mes Anterior: R$ ${lastMonthEarnings.toFixed(2)}`, 20, 195);
        doc.text(`Variacao: ${earningsDiffPercent >= 0 ? '+' : ''}${earningsDiffPercent.toFixed(1)}%`, 20, 202);

        doc.addPage();
        doc.setFontSize(14);
        doc.text('Ganhos por Plataforma', 20, 20);
        
        doc.setFontSize(11);
        let yPos = 30;
        Object.entries(earningsByPlatform).forEach(([platform, value]) => {
          doc.text(`${platform}: R$ ${value.toFixed(2)}`, 20, yPos);
          yPos += 7;
        });

        doc.save('relatorio-financeiro.pdf');
      };

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="text-4xl mb-2">‚è≥</div>
              <div className="text-gray-600">Carregando...</div>
            </div>
          </div>
        );
      }

      if (!user) {
        return (
          <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-slate-900 via-slate-800 to-sky-700">
            <div className="w-full max-w-md">
              <div className="flex flex-col items-center mb-6">
                <img
                  src="https://i.ibb.co/Y4Jpys2S/download.png"
                  alt="Gest√£o Financeira Inteligente"
                  className="w-64 h-64 rounded-2xl mb-4 shadow-xl object-cover"
                />
                <h1 className="text-2xl font-bold text-white">Gest√£o Financeira Inteligente</h1>
                <p className="text-sm text-slate-200 mt-1 text-center px-4">
                  Finan√ßas claras, decis√µes inteligentes.
                </p>
              </div>

              <div className="bg-white/95 backdrop-blur rounded-2xl shadow-xl p-6">
                <div className="flex gap-2 mb-4">
                  <button
                    onClick={() => setAuthMode('login')}
                    className={`flex-1 py-2 rounded-xl text-sm font-medium transition
                      ${authMode === 'login'
                        ? 'bg-sky-600 text-white shadow'
                        : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}
                  >
                    Entrar
                  </button>
                  <button
                    onClick={() => setAuthMode('signup')}
                    className={`flex-1 py-2 rounded-xl text-sm font-medium transition
                      ${authMode === 'signup'
                        ? 'bg-sky-600 text-white shadow'
                        : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}
                  >
                    Cadastrar
                  </button>
                </div>

                <form onSubmit={handleAuth} className="space-y-4">
                  <div>
                    <label className="block text-xs font-semibold mb-1 text-slate-700">
                      E-mail
                    </label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                      placeholder="seu@email.com"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-semibold mb-1 text-slate-700">
                      Senha
                    </label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                      placeholder="m√≠nimo 6 caracteres"
                      required
                    />
                  </div>

                  {authError && (
                    <div className="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg text-xs">
                      {authError}
                    </div>
                  )}

                  <button
                    type="submit"
                    className="w-full bg-sky-600 hover:bg-sky-700 text-white py-2.5 rounded-xl font-semibold text-sm shadow-md transition"
                  >
                    {authMode === 'login' ? 'Entrar' : 'Criar Conta'}
                  </button>
                </form>

                <p className="text-[11px] text-slate-400 text-center mt-4">
                  Seus dados financeiros ficam salvos na nuvem com seguran√ßa.
                </p>
              </div>
            </div>
          </div>
        );
      }

      const mobileCardClass = "bg-white rounded-lg shadow p-4 mb-3";

      const allPlatforms = [...defaultPlatforms, ...customPlatforms.map(p => p.name), 'Outra'];

      return (
        <div className="min-h-screen flex flex-col bg-slate-50">
          <header className="bg-gradient-to-r from-slate-900 via-slate-800 to-sky-700 text-white p-4 shadow-lg">
            <div className="flex justify-between items-center max-w-xl mx-auto">
              <div>
                <h1 className="text-xl font-bold">üí∞ Gest√£o Financeira</h1>
                <p className="text-xs text-slate-200">{user.email}</p>
              </div>
              <button
                onClick={handleLogout}
                className="bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg text-sm transition"
              >
                Sair
              </button>
            </div>
          </header>

          <nav className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg flex justify-around py-2 text-xs sm:text-sm z-20">
            <button
              onClick={() => setActiveTab('dashboard')}
              className={`flex flex-col items-center px-3 py-1 ${activeTab === 'dashboard' ? 'text-sky-600 font-semibold' : 'text-gray-500'}`}
            >
              <span className="text-lg">üìä</span>
              <span>Dashboard</span>
            </button>
            <button
              onClick={() => setActiveTab('ganhos')}
              className={`flex flex-col items-center px-3 py-1 ${activeTab === 'ganhos' ? 'text-sky-600 font-semibold' : 'text-gray-500'}`}
            >
              <span className="text-lg">üíµ</span>
              <span>Ganhos</span>
            </button>
            <button
              onClick={() => setActiveTab('despesas-trabalho')}
              className={`flex flex-col items-center px-3 py-1 ${activeTab === 'despesas-trabalho' ? 'text-sky-600 font-semibold' : 'text-gray-500'}`}
            >
              <span className="text-lg">‚õΩ</span>
              <span>Trabalho</span>
            </button>
            <button
              onClick={() => setActiveTab('despesas-casa')}
              className={`flex flex-col items-center px-3 py-1 ${activeTab === 'despesas-casa' ? 'text-sky-600 font-semibold' : 'text-gray-500'}`}
            >
              <span className="text-lg">üè†</span>
              <span>Casa</span>
            </button>
          </nav>

          <main className="flex-1 p-3 pb-20 max-w-xl mx-auto w-full">
            {activeTab === 'dashboard' && (
              <div>
                {/* Filtro de per√≠odo + Exportar PDF */}
                <div className="bg-white rounded-xl shadow-lg p-3 mb-4">
                  <div className="flex gap-2 mb-2">
                    <button
                      onClick={() => setFilterPeriod('week')}
                      className={`flex-1 py-1.5 rounded-lg text-xs font-medium transition ${filterPeriod === 'week' ? 'bg-sky-600 text-white' : 'bg-slate-100 text-slate-700'}`}
                    >
                      Semana
                    </button>
                    <button
                      onClick={() => setFilterPeriod('month')}
                      className={`flex-1 py-1.5 rounded-lg text-xs font-medium transition ${filterPeriod === 'month' ? 'bg-sky-600 text-white' : 'bg-slate-100 text-slate-700'}`}
                    >
                      M√™s
                    </button>
                    <button
                      onClick={() => setFilterPeriod('year')}
                      className={`flex-1 py-1.5 rounded-lg text-xs font-medium transition ${filterPeriod === 'year' ? 'bg-sky-600 text-white' : 'bg-slate-100 text-slate-700'}`}
                    >
                      Ano
                    </button>
                    <button
                      onClick={() => setFilterPeriod('all')}
                      className={`flex-1 py-1.5 rounded-lg text-xs font-medium transition ${filterPeriod === 'all' ? 'bg-sky-600 text-white' : 'bg-slate-100 text-slate-700'}`}
                    >
                      Tudo
                    </button>
                  </div>
                  <button
                    onClick={exportPDF}
                    className="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg text-sm font-semibold transition flex items-center justify-center gap-2"
                  >
                    üìÑ Exportar PDF
                  </button>
                </div>

                {/* Ganhos por plataforma */}
                {Object.keys(earningsByPlatform).length > 0 && (
                  <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                    <h3 className="text-sm font-bold text-slate-700 mb-3 flex items-center">
                      <span className="mr-2">üöó</span>
                      Ganhos por Plataforma
                    </h3>
                    <div className="space-y-2">
                      {Object.entries(earningsByPlatform)
                        .sort((a, b) => b[1] - a[1])
                        .map(([platform, value]) => (
                          <div key={platform} className="flex justify-between items-center bg-slate-50 rounded-lg px-3 py-2">
                            <span className="font-medium text-slate-700">{platform}</span>
                            <span className="font-bold text-emerald-600">R$ {value.toFixed(2)}</span>
                          </div>
                        ))}
                    </div>
                  </div>
                )}

                {/* Compara√ß√£o m√™s a m√™s */}
                <div className="bg-gradient-to-br from-indigo-600 to-indigo-700 text-white rounded-xl p-4 mb-4 shadow-lg">
                  <h3 className="text-sm font-bold mb-3 flex items-center">
                    <span className="mr-2">üìÖ</span>
                    Compara√ß√£o Mensal
                  </h3>
                  <div className="grid grid-cols-2 gap-3 text-xs">
                    <div>
                      <div className="opacity-80">Receita M√™s Atual</div>
                      <div className="text-lg font-bold">R$ {currentMonthEarnings.toFixed(2)}</div>
                    </div>
                    <div>
                      <div className="opacity-80">Receita M√™s Anterior</div>
                      <div className="text-lg font-bold">R$ {lastMonthEarnings.toFixed(2)}</div>
                    </div>
                    <div>
                      <div className="opacity-80">Lucro M√™s Atual</div>
                      <div className="text-lg font-bold">R$ {currentMonthProfit.toFixed(2)}</div>
                    </div>
                    <div>
                      <div className="opacity-80">Lucro M√™s Anterior</div>
                      <div className="text-lg font-bold">R$ {lastMonthProfit.toFixed(2)}</div>
                    </div>
                  </div>
                  <div className="mt-3 pt-3 border-t border-white/20">
                    <div className="flex justify-between text-xs">
                      <span>Varia√ß√£o Receita:</span>
                      <span className={`font-bold ${earningsDiff >= 0 ? 'text-green-200' : 'text-red-200'}`}>
                        {earningsDiff >= 0 ? '+' : ''}{earningsDiffPercent.toFixed(1)}% (R$ {earningsDiff.toFixed(2)})
                      </span>
                    </div>
                    <div className="flex justify-between text-xs mt-1">
                      <span>Varia√ß√£o Lucro:</span>
                      <span className={`font-bold ${profitDiff >= 0 ? 'text-green-200' : 'text-red-200'}`}>
                        {profitDiff >= 0 ? '+' : ''}{profitDiffPercent.toFixed(1)}% (R$ {profitDiff.toFixed(2)})
                      </span>
                    </div>
                  </div>
                </div>

                {/* Cards principais */}
                <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className="bg-gradient-to-br from-emerald-500 to-emerald-600 text-white rounded-xl p-4 shadow-lg">
                    <div className="text-xs opacity-90 font-medium">Receita</div>
                    <div className="text-2xl font-bold mt-1">R$ {totalEarnings.toFixed(2)}</div>
                    <div className="text-xs opacity-75 mt-1">{totalDays} registros</div>
                  </div>
                  <div className="bg-gradient-to-br from-amber-500 to-amber-600 text-white rounded-xl p-4 shadow-lg">
                    <div className="text-xs opacity-90 font-medium">Despesas Trabalho</div>
                    <div className="text-2xl font-bold mt-1">R$ {totalExpenses.toFixed(2)}</div>
                  </div>
                  <div className="bg-gradient-to-br from-sky-500 to-sky-600 text-white rounded-xl p-4 shadow-lg">
                    <div className="text-xs opacity-90 font-medium">Lucro Trabalho</div>
                    <div className="text-2xl font-bold mt-1">R$ {workProfit.toFixed(2)}</div>
                  </div>
                  <div className="bg-gradient-to-br from-rose-500 to-rose-600 text-white rounded-xl p-4 shadow-lg">
                    <div className="text-xs opacity-90 font-medium">Despesas Casa</div>
                    <div className="text-2xl font-bold mt-1">R$ {totalHouseExpenses.toFixed(2)}</div>
                  </div>
                </div>

                {/* Saldo final */}
                <div className={`${finalBalance >= 0 ? 'bg-gradient-to-br from-teal-600 to-teal-700' : 'bg-gradient-to-br from-red-600 to-red-700'} text-white rounded-xl p-5 mb-4 shadow-lg`}>
                  <div className="text-sm opacity-90 font-medium">Saldo Final</div>
                  <div className="text-3xl font-bold mt-1">R$ {finalBalance.toFixed(2)}</div>
                </div>

                {/* Proje√ß√µes do m√™s */}
                <div className="bg-gradient-to-br from-purple-600 to-purple-700 text-white rounded-xl p-4 mb-4 shadow-lg">
                  <h3 className="text-sm font-bold mb-3 flex items-center">
                    <span className="mr-2">üîÆ</span>
                    Proje√ß√£o do M√™s (baseado em 7 dias)
                  </h3>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <div className="text-xs opacity-80">Receita Projetada</div>
                      <div className="text-xl font-bold">R$ {projecaoReceita.toFixed(2)}</div>
                    </div>
                    <div>
                      <div className="text-xs opacity-80">Lucro Projetado</div>
                      <div className="text-xl font-bold">R$ {projecaoLucro.toFixed(2)}</div>
                    </div>
                  </div>
                  <div className="text-xs opacity-75 mt-2">
                    Faltam {diasRestantes} dias para o fim do m√™s
                  </div>
                </div>

                {/* Gr√°fico de evolu√ß√£o */}
                <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                  <h3 className="text-sm font-bold text-slate-700 mb-3 flex items-center">
                    <span className="mr-2">üìà</span>
                    Evolu√ß√£o (√∫ltimos 7 dias)
                  </h3>
                  <div style={{ height: '220px' }}>
                    <canvas ref={chartRef}></canvas>
                  </div>
                </div>

                {/* Gr√°fico de barras - Indicadores + Proje√ß√£o */}
                <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                  <h3 className="text-sm font-bold text-slate-700 mb-3 flex items-center">
                    <span className="mr-2">üìä</span>
                    Indicadores & Proje√ß√µes
                  </h3>
                  <div style={{ height: '220px' }}>
                    <canvas ref={barChartRef}></canvas>
                  </div>
                </div>

                {/* Indicadores de efici√™ncia */}
                <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                  <h3 className="text-sm font-bold text-slate-700 mb-3 flex items-center">
                    <span className="mr-2">üéØ</span>
                    Indicadores de Efici√™ncia
                  </h3>
                  <div className="grid grid-cols-3 gap-3">
                    <div className="bg-slate-50 rounded-lg p-3 text-center">
                      <div className="text-xs text-slate-500 mb-1">Ganho/Dia</div>
                      <div className="text-lg font-bold text-emerald-600">
                        R$ {ticketMedio.toFixed(2)}
                      </div>
                    </div>
                    <div className="bg-slate-50 rounded-lg p-3 text-center">
                      <div className="text-xs text-slate-500 mb-1">Custo/Dia</div>
                      <div className="text-lg font-bold text-amber-600">
                        R$ {custoPorDia.toFixed(2)}
                      </div>
                    </div>
                    <div className="bg-slate-50 rounded-lg p-3 text-center">
                      <div className="text-xs text-slate-500 mb-1">Margem</div>
                      <div className={`text-lg font-bold ${margemLucro >= 0 ? 'text-sky-600' : 'text-red-600'}`}>
                        {margemLucro.toFixed(1)}%
                      </div>
                    </div>
                  </div>
                </div>

                {/* Atividade recente */}
                <div className="bg-white rounded-xl shadow-lg p-4">
                  <h2 className="text-sm font-bold text-slate-700 mb-3 flex items-center">
                    <span className="mr-2">üìã</span>
                    Atividade Recente
                  </h2>
                  <div className="space-y-2 text-sm">
                    {[...filteredEarnings.slice(0, 3).map(r => ({...r, type: 'earning'})),
                      ...filteredExpenses.slice(0, 3).map(e => ({...e, type: 'expense'})),
                      ...filteredHouseExpenses.slice(0, 3).map(h => ({...h, type: 'house'}))]
                      .sort((a, b) => new Date(b.date) - new Date(a.date))
                      .slice(0, 5)
                      .map((item, idx) => (
                        <div key={idx} className="flex justify-between items-center bg-slate-50 rounded-lg px-3 py-2.5">
                          <div>
                            <span className="font-semibold text-slate-700">
                              {item.type === 'earning' && `üíµ ${item.platform || 'Ganho'}`}
                              {item.type === 'expense' && '‚õΩ Trabalho'}
                              {item.type === 'house' && 'üè† Casa'}
                            </span>
                            <span className="text-slate-400 text-xs ml-2">{item.date}</span>
                          </div>
                          <span className={`font-bold ${item.type === 'earning' ? 'text-emerald-600' : 'text-red-600'}`}>
                            {item.type === 'earning' ? '+' : '-'} R$ {item.value.toFixed(2)}
                          </span>
                        </div>
                      ))}
                    {filteredEarnings.length === 0 && filteredExpenses.length === 0 && filteredHouseExpenses.length === 0 && (
                      <p className="text-center text-slate-400 py-6 text-xs">
                        Nenhuma atividade registrada ainda
                      </p>
                    )}
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'ganhos' && (
              <div>
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-lg font-bold text-slate-700">üíµ Ganhos</h2>
                  <button
                    onClick={() => setShowEarningModal(true)}
                    className="bg-emerald-600 hover:bg-emerald-700 text-white text-sm px-4 py-2 rounded-lg shadow transition"
                  >
                    + Ganho
                  </button>
                </div>

                {/* Gerenciar plataformas customizadas */}
                {customPlatforms.length > 0 && (
                  <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                    <h3 className="text-sm font-bold text-slate-700 mb-3">Minhas Plataformas</h3>
                    <div className="space-y-2">
                      {customPlatforms.map(platform => (
                        <div key={platform.id} className="flex justify-between items-center bg-slate-50 rounded-lg px-3 py-2">
                          <span className="text-sm font-medium text-slate-700">{platform.name}</span>
                          <button
                            onClick={() => deleteCustomPlatform(platform.id)}
                            className="text-xs text-red-600 hover:text-red-700 font-medium"
                          >
                            Excluir
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {filteredEarnings.length === 0 && (
                  <p className="text-center text-slate-400 text-sm mt-6">
                    Nenhum ganho registrado
                  </p>
                )}

                {filteredEarnings.map(earning => (
                  <div key={earning.id} className={mobileCardClass}>
                    <div className="flex justify-between items-center mb-1">
                      <div>
                        <span className="font-semibold text-slate-700">{earning.platform || 'Ganho'}</span>
                        <span className="text-xs text-slate-400 ml-2">{earning.date}</span>
                      </div>
                      <button
                        onClick={() => deleteEarning(earning.id)}
                        className="text-xs text-red-600 hover:text-red-700 font-medium"
                      >
                        Excluir
                      </button>
                    </div>
                    <div className="mt-2">
                      <span className="font-bold text-emerald-600 text-lg">R$ {earning.value.toFixed(2)}</span>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {activeTab === 'despesas-trabalho' && (
              <div>
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-lg font-bold text-slate-700">‚õΩ Despesas Trabalho</h2>
                  <button
                    onClick={() => setShowExpenseModal(true)}
                    className="bg-amber-600 hover:bg-amber-700 text-white text-sm px-4 py-2 rounded-lg shadow transition"
                  >
                    + Despesa
                  </button>
                </div>

                {filteredExpenses.length === 0 && (
                  <p className="text-center text-slate-400 text-sm mt-6">
                    Nenhuma despesa registrada
                  </p>
                )}

                {filteredExpenses.map(expense => (
                  <div key={expense.id} className={mobileCardClass}>
                    <div className="flex justify-between items-center mb-1">
                      <span className="font-semibold text-slate-700">{expense.category}</span>
                      <span className="text-xs text-slate-400">{expense.date}</span>
                    </div>
                    {expense.description && (
                      <div className="text-sm text-slate-500 mb-2">
                        {expense.description}
                      </div>
                    )}
                    <div className="flex justify-between items-center">
                      <span className="font-bold text-red-600 text-lg">R$ {expense.value.toFixed(2)}</span>
                      <button
                        onClick={() => deleteExpense(expense.id)}
                        className="text-xs text-red-600 hover:text-red-700 font-medium"
                      >
                        Excluir
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {activeTab === 'despesas-casa' && (
              <div>
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-lg font-bold text-slate-700">üè† Despesas Casa</h2>
                  <button
                    onClick={() => setShowHouseModal(true)}
                    className="bg-rose-600 hover:bg-rose-700 text-white text-sm px-4 py-2 rounded-lg shadow transition"
                  >
                    + Despesa
                  </button>
                </div>

                {filteredHouseExpenses.length === 0 && (
                  <p className="text-center text-slate-400 text-sm mt-6">
                    Nenhuma despesa registrada
                  </p>
                )}

                {filteredHouseExpenses.map(house => (
                  <div key={house.id} className={mobileCardClass}>
                    <div className="flex justify-between items-center mb-1">
                      <span className="font-semibold text-slate-700">{house.category}</span>
                      <span className="text-xs text-slate-400">{house.date}</span>
                    </div>
                    {house.description && (
                      <div className="text-sm text-slate-500 mb-2">
                        {house.description}
                      </div>
                    )}
                    <div className="flex justify-between items-center">
                      <span className="font-bold text-red-600 text-lg">R$ {house.value.toFixed(2)}</span>
                      <button
                        onClick={() => deleteHouseExpense(house.id)}
                        className="text-xs text-red-600 hover:text-red-700 font-medium"
                      >
                        Excluir
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </main>

          {/* Modal: Novo Ganho */}
          {showEarningModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-30">
              <div className="bg-white rounded-xl p-5 w-full max-w-sm shadow-2xl">
                <h3 className="text-lg font-bold mb-4 text-slate-700">üíµ Novo Ganho</h3>
                <div className="space-y-3 text-sm">
                  <div>
                    <label className="block mb-1 font-medium text-slate-600">Data</label>
                    <input
                      type="date"
                      value={earningForm.date}
                      onChange={e => setEarningForm({...earningForm, date: e.target.value})}
                      className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    />
                  </div>
                  <div>
                    <label className="block mb-1 font-medium text-slate-600">Plataforma</label>
                    <select
                      value={earningForm.platform}
                      onChange={e => setEarningForm({...earningForm, platform: e.target.value})}
                      className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    >
                      {allPlatforms.map(platform => (
                        <option key={platform} value={platform}>{platform}</option>
                      ))}
                    </select>
                  </div>
                  {earningForm.platform === 'Outra' && (
                    <div>
                      <label className="block mb-1 font-medium text-slate-600">Nome da Plataforma</label>
                      <input
                        type="text"
                        value={earningForm.customPlatform}
                        onChange={e => setEarningForm({...earningForm, customPlatform: e.target.value})}
                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="Ex: Cabify, Bolt, etc."
                      />
                    </div>
                  )}
                  <div>
                    <label className="block mb-1 font-medium text-slate-600">Valor (R$)</label>
                    <input
                      type="number"
                      step="0.01"
                      value={earningForm.value}
                      onChange={e => setEarningForm({...earningForm, value: e.target.value})}
                      className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      placeholder="0,00"
                    />
                  </div>
                </div>
                <div className="flex gap-2 mt-5">
                  <button
                    onClick={() => setShowEarningModal(false)}
                    className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-2.5 rounded-lg font-medium transition"
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={addEarning}
                    className="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 rounded-lg font-medium transition"
                  >
                    Salvar
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Modal: Nova Despesa Trabalho */}
          {showExpenseModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-30">
              <div className="bg-white rounded-xl p-5 w-full max-w-sm shadow-2xl">
                <h3 className="text-lg font-bold mb-4 text-slate-700">‚õΩ Nova Despesa Trabalho</h3>
                <div className="space-y-3 text-sm">
                  <div>
                    <label className="block mb-1 font-medium text-slate-600">Data</label>
                    <input
                      type="date"
                      value={expenseForm.date}
                      onChange={e => setExpenseForm({...expenseForm, date: e.target.value})}
                      className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                    />
                  </div>
                  <div>
                    <label className="block mb-1 font-medium text-slate-600">Categoria</label>
                    <select
                      value={expenseForm.category}
                      onChange={e => setExpenseForm({...expenseForm, category: e.target.value})}
                      className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                    >
                      <option>Combust√≠vel</option>
                      <option>Manuten√ß√£o</option>
                      <option>Lavagem</option>
                      <option>Ped√°gio</option>
                      <option>Estacionamento</option>
                      <option>√Ågua/Lanche</option>
                      <option>Outro</option>
                    </select>
                  </div>
                  <div>
                    <label className="block mb-1 font-medium text-slate-600">Descri√ß√£o</label>
                    <input
                      type="text"
                      value={expenseForm.description}
                      onChange={e => setExpenseForm({...expenseForm, description: e.target.value})}
                      className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                      placeholder="Detalhes da despesa"
                    />
                  </div>
                  <div>
                    <label className="block mb-1 font-medium text-slate-600">Valor (R$)</label>
                    <input
                      type="number"
                      step="0.01"
                      value={expenseForm.value}
                      onChange={e => setExpenseForm({...expenseForm, value: e.target.value})}
                      className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                      placeholder="0,00"
                    />
                  </div>
                </div>
                <div className="flex gap-2
